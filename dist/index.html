<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>TaoLiuJun&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Html&#x2F;Css&#x2F;JavaScript&#x2F;TypeScript的学习心得；React的学习心得；技术设计思想；生活随想；">
<meta property="og:type" content="website">
<meta property="og:title" content="TaoLiuJun&#39;s Blog">
<meta property="og:url" content="https://taoliujun.github.io/blog/index.html">
<meta property="og:site_name" content="TaoLiuJun&#39;s Blog">
<meta property="og:description" content="Html&#x2F;Css&#x2F;JavaScript&#x2F;TypeScript的学习心得；React的学习心得；技术设计思想；生活随想；">
<meta property="og:locale">
<meta property="article:author" content="taoliujun">
<meta property="article:tag" content="前端 JavaScript TypeScript React NodeJS">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/blog/atom.xml" title="TaoLiuJun's Blog" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/blog/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/blog/css/style.css">

  
    
<link rel="stylesheet" href="/blog/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/blog/" id="logo">TaoLiuJun&#39;s Blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/blog/" id="subtitle">博客更新有延迟，在 https://github.com/taoliujun/blog/issues 获取最新文章和讨论</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/blog/">Home</a>
        
          <a class="main-nav-link" href="/blog/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/blog/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Suche"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Suche"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://taoliujun.github.io/blog"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-web-api-Beacon_api" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/web-api-Beacon_api/" class="article-date">
  <time class="dt-published" datetime="2024-02-28T23:21:58.000Z" itemprop="datePublished">2024-02-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/JavaScript/">JavaScript</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/web-api-Beacon_api/">Web API - Beacon</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>原文链接：<a target="_blank" rel="noopener" href="https://github.com/taoliujun/blog/issues/53">https://github.com/taoliujun/blog/issues/53</a></p>
<!--hexo
---
url: web-api-Beacon_api
tags:
  - webapi
  - Beacon
---
-->

<h1 id="Badging"><a href="#Badging" class="headerlink" title="Badging"></a>Badging</h1><blockquote>
<p>MDN: <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/Beacon_API">https://developer.mozilla.org/zh-CN/docs/Web/API/Beacon_API</a></p>
</blockquote>
<p><strong>Beacon</strong>用于发送请求到服务器，且不需要响应。浏览器会保证在页面卸载前，将请求运行完成。主要使用场景是发送统计数据。</p>
<h2 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h2><h3 id="sendBeacon"><a href="#sendBeacon" class="headerlink" title="sendBeacon"></a>sendBeacon</h3><p>通过<em>POST</em>发送少量数据到服务器。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">navigator.<span class="title function_">sendBeacon</span>(url, data);</span><br></pre></td></tr></table></figure>

<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><p>创建一个页面，放一个按钮用于发送<code>manual</code>统计数据：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;javascript:sendData(&#x27;manual&#x27;);&quot;</span>&gt;</span>sendData<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在页面隐藏、卸载的时候发送<code>hidden</code>统计数据：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;visibilitychange&quot;</span>, <span class="function">()=&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">document</span>.<span class="property">visibilityState</span> === <span class="string">&quot;hidden&quot;</span>) &#123;</span><br><span class="line">    <span class="title function_">sendData</span>(<span class="string">&#x27;hidden&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>发送统计数据的函数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> data = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sendData</span>(<span class="params">source</span>) &#123;</span><br><span class="line">  data += <span class="number">1</span>;</span><br><span class="line">  <span class="comment">// getUrl用于获取服务端地址</span></span><br><span class="line">  navigator.<span class="title function_">sendBeacon</span>(<span class="title function_">getUrl</span>(), <span class="keyword">new</span> <span class="title class_">URLSearchParams</span>(&#123; data, source &#125;));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建服务端，打印<em>request body</em>数据以测试点击按钮、关闭页面的效果，发现关闭页面后也发送了数据。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">body: [Object: null prototype] &#123; data: <span class="string">&#x27;1&#x27;</span>, <span class="built_in">source</span>: <span class="string">&#x27;manual&#x27;</span> &#125;</span><br><span class="line">body: [Object: null prototype] &#123; data: <span class="string">&#x27;2&#x27;</span>, <span class="built_in">source</span>: <span class="string">&#x27;hidden&#x27;</span> &#125;</span><br></pre></td></tr></table></figure>


<p>示例：<a href="https://taoliujun.github.io/example/web-apis/Beacon_API/index.html">https://taoliujun.github.io/example/web-apis/Beacon_API/index.html</a></p>
<blockquote>
<p>需要服务端配合打印日志。服务端代码见：<a href="https://taoliujun.github.io/example/web-apis/Beacon_API/http.js">https://taoliujun.github.io/example/web-apis/Beacon_API/http.js</a></p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://taoliujun.github.io/blog/web-api-Beacon_api/" data-id="clt6wgwbr0001h1q5djh315b4" data-title="Web API - Beacon" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Beacon/" rel="tag">Beacon</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/webapi/" rel="tag">webapi</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-web-api-badging_api" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/web-api-badging_api/" class="article-date">
  <time class="dt-published" datetime="2024-02-28T00:22:00.000Z" itemprop="datePublished">2024-02-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/JavaScript/">JavaScript</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/web-api-badging_api/">Web API - Badging - 徽章</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>原文链接：<a target="_blank" rel="noopener" href="https://github.com/taoliujun/blog/issues/50">https://github.com/taoliujun/blog/issues/50</a></p>
<!--hexo
---
url: web-api-badging_api
tags:
  - webapi
  - badging
---
-->

<h1 id="Badging"><a href="#Badging" class="headerlink" title="Badging"></a>Badging</h1><blockquote>
<p>MDN: <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Badging_API">https://developer.mozilla.org/en-US/docs/Web/API/Badging_API</a></p>
</blockquote>
<p>Badging用于在Web APP的图标上<strong>标记徽章</strong>，常用于通知用户有新消息啦，它有3种状态：</p>
<table>
<thead>
<tr>
<th>状态</th>
<th>描述</th>
<th>效果</th>
</tr>
</thead>
<tbody><tr>
<td>nothing</td>
<td>什么都没有</td>
<td><img src="https://github.com/taoliujun/blog/assets/5689134/0410ffdf-fbf3-41aa-b3b5-de0aa2ceb671" alt="image"></td>
</tr>
<tr>
<td>flag</td>
<td>一个圆点</td>
<td><img src="https://github.com/taoliujun/blog/assets/5689134/965f2c77-8b85-443f-8f97-da491df88354" alt="image"></td>
</tr>
<tr>
<td>integer</td>
<td>一个数字，最大显示99+</td>
<td><img src="https://github.com/taoliujun/blog/assets/5689134/f0333758-125b-40b9-a88b-285346730816" alt="image"></td>
</tr>
</tbody></table>
<h2 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h2><h3 id="setAppBadge"><a href="#setAppBadge" class="headerlink" title="setAppBadge"></a>setAppBadge</h3><p>设置徽章。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置圆点</span></span><br><span class="line">navigator.<span class="title function_">setAppBadge</span>();</span><br><span class="line"><span class="comment">// 设置数字</span></span><br><span class="line">navigator.<span class="title function_">setAppBadge</span>(<span class="number">12</span>);</span><br><span class="line"><span class="comment">// 设置大数字</span></span><br><span class="line">navigator.<span class="title function_">setAppBadge</span>(<span class="number">1234</span>);</span><br></pre></td></tr></table></figure>

<h3 id="clearAppBadge"><a href="#clearAppBadge" class="headerlink" title="clearAppBadge"></a>clearAppBadge</h3><p>清空徽章。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">navigator.<span class="title function_">clearAppBadge</span>();</span><br></pre></td></tr></table></figure>

<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><p><a href="https://taoliujun.github.io/example/web-apis/Badging_API/index.html">https://taoliujun.github.io/example/web-apis/Badging_API/index.html</a></p>
<blockquote>
<p>Badging在Web APP中生效，用chrome打开示例链接，从链接中安装PWA，然后运行PWA测试。</p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://taoliujun.github.io/blog/web-api-badging_api/" data-id="clt5metnc0000hgp546udb8su" data-title="Web API - Badging - 徽章" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/badging/" rel="tag">badging</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/webapi/" rel="tag">webapi</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-web-api-Badging_api" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/web-api-Badging_api/" class="article-date">
  <time class="dt-published" datetime="2024-02-28T00:22:00.000Z" itemprop="datePublished">2024-02-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/JavaScript/">JavaScript</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/web-api-Badging_api/">Web API - Badging</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>原文链接：<a target="_blank" rel="noopener" href="https://github.com/taoliujun/blog/issues/50">https://github.com/taoliujun/blog/issues/50</a></p>
<!--hexo
---
url: web-api-Badging_api
tags:
  - webapi
  - Badging
---
-->

<h1 id="Badging"><a href="#Badging" class="headerlink" title="Badging"></a>Badging</h1><blockquote>
<p>MDN: <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Badging_API">https://developer.mozilla.org/en-US/docs/Web/API/Badging_API</a></p>
</blockquote>
<p><strong>Badging</strong>用于在Web APP的图标上<strong>标记徽章</strong>，常用于通知用户有新消息啦，它有3种状态：</p>
<table>
<thead>
<tr>
<th>状态</th>
<th>描述</th>
<th>效果</th>
</tr>
</thead>
<tbody><tr>
<td>nothing</td>
<td>什么都没有</td>
<td><img src="https://github.com/taoliujun/blog/assets/5689134/0410ffdf-fbf3-41aa-b3b5-de0aa2ceb671" alt="image"></td>
</tr>
<tr>
<td>flag</td>
<td>一个圆点</td>
<td><img src="https://github.com/taoliujun/blog/assets/5689134/965f2c77-8b85-443f-8f97-da491df88354" alt="image"></td>
</tr>
<tr>
<td>integer</td>
<td>一个数字，最大显示99+</td>
<td><img src="https://github.com/taoliujun/blog/assets/5689134/f0333758-125b-40b9-a88b-285346730816" alt="image"></td>
</tr>
</tbody></table>
<h2 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h2><h3 id="setAppBadge"><a href="#setAppBadge" class="headerlink" title="setAppBadge"></a>setAppBadge</h3><p>设置徽章。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置圆点</span></span><br><span class="line">navigator.<span class="title function_">setAppBadge</span>();</span><br><span class="line"><span class="comment">// 设置数字</span></span><br><span class="line">navigator.<span class="title function_">setAppBadge</span>(<span class="number">12</span>);</span><br><span class="line"><span class="comment">// 设置大数字</span></span><br><span class="line">navigator.<span class="title function_">setAppBadge</span>(<span class="number">1234</span>);</span><br></pre></td></tr></table></figure>

<h3 id="clearAppBadge"><a href="#clearAppBadge" class="headerlink" title="clearAppBadge"></a>clearAppBadge</h3><p>清空徽章。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">navigator.<span class="title function_">clearAppBadge</span>();</span><br></pre></td></tr></table></figure>

<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><p><a href="https://taoliujun.github.io/example/web-apis/Badging_API/index.html">https://taoliujun.github.io/example/web-apis/Badging_API/index.html</a></p>
<blockquote>
<p>Badging在Web APP中生效，用chrome打开示例链接，从链接中安装PWA，然后运行PWA测试。</p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://taoliujun.github.io/blog/web-api-Badging_api/" data-id="clt6wgwbo0000h1q50s53g49t" data-title="Web API - Badging" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Badging/" rel="tag">Badging</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/webapi/" rel="tag">webapi</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-web-api-readme" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/web-api-readme/" class="article-date">
  <time class="dt-published" datetime="2024-02-28T00:10:53.000Z" itemprop="datePublished">2024-02-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/JavaScript/">JavaScript</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/web-api-readme/">Web API 实践，最后更新2024/02月...</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>原文链接：<a target="_blank" rel="noopener" href="https://github.com/taoliujun/blog/issues/49">https://github.com/taoliujun/blog/issues/49</a></p>
<!--hexo
---
url: web-api-readme
tags:
  - webapi
---
-->

<p><a target="_blank" rel="noopener" href="https://www.w3.org/TR/">Web API</a>的发展日新月异，稍不留神就偷偷的出了新规范，这些规范为项目方案提供了更多的可能性。话说读百遍不如写一遍，计划在一段时间内，对大部分API进行demo实践以加深印象。</p>
<blockquote>
<p>以 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API">https://developer.mozilla.org/en-US/docs/Web/API</a> 为基础，只实践W3C Recommendation状态的API。</p>
</blockquote>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul>
<li><input disabled="" type="checkbox"> #50 </li>
<li><input disabled="" type="checkbox"> #53</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://taoliujun.github.io/blog/web-api-readme/" data-id="clt5mqzmy0000hjqiesxk2c8x" data-title="Web API 实践，最后更新2024/02月..." class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/webapi/" rel="tag">webapi</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-snapshot-impact-on-coverage" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/snapshot-impact-on-coverage/" class="article-date">
  <time class="dt-published" datetime="2024-01-09T00:44:02.000Z" itemprop="datePublished">2024-01-09</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/%E5%B7%A5%E7%A8%8B%E5%8C%96/">工程化</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/snapshot-impact-on-coverage/">snapshot对单测覆盖率的影响以及应对方案</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>原文链接：<a target="_blank" rel="noopener" href="https://github.com/taoliujun/blog/issues/46">https://github.com/taoliujun/blog/issues/46</a></p>
<!--hexo
---
url: snapshot-impact-on-coverage
tags:
  - jest
---
-->

<p>Jest snapshot是把双刃剑，虽然使用它可以快速的编写测试用例，但它导致开发者忽略了测试用例的细节设计。</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>试想一个场景，有一个方法返回了复杂的结构，开发者A由于懒惰或自信以后能根据snapshot的结果来修复问题，而只写了snapshot。过了一段时间，开发者A或B修改了该方法，发现snapshot匹配失败，那么他会这样做：</p>
<ol>
<li>仔细检查匹配失败的原因，然后或修改代码、或更新snapshot。</li>
<li>直接更新snapshot。</li>
</ol>
<p>我相信，大部分人都会选择第二种方式，因为这样更快，更简单。但后果是，大家都只关心了方法的结果，而忽略了方法的细节设计，这样的测试用例是不可靠的。即便在pull request环节，Reviewers面对难以阅读的snapshot文件，也往往是选择了approve。</p>
<p>所以，需要一个方案来实现几个目的：</p>
<ul>
<li>保留snapshot对复杂结构进行测试。</li>
<li>snapshot不提高覆盖率，因为低覆盖率会警告开发者去关注测试用例的细节设计。</li>
</ul>
<h2 id="方案"><a href="#方案" class="headerlink" title="方案"></a>方案</h2><p>因为jest的限制，执行用例肯定会影响覆盖率。那么可以执行两次用例，一次是执行包含snapshot的文件来校验用例，一次是执行不包含snapshot的文件来生成测试覆盖率。</p>
<p>于是，新增两个<code>script</code>：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// package.json</span></span><br><span class="line"><span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;test&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pnpm exec jest&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;test:coverage&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pnpm exec jest --config=jest.coverage.config.js&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>

<p>默认的<code>jest.config.js</code>配置不包含覆盖率配置，而<code>jest.coverage.config.js</code>包含覆盖率配置。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// jest.config.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// jest.coverage.config.js</span></span><br><span class="line"><span class="keyword">const</span> baseConfig = <span class="built_in">require</span>(<span class="string">&#x27;./jest.config&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    ...baseConfig,</span><br><span class="line"></span><br><span class="line">    <span class="attr">testMatch</span>: [<span class="string">&#x27;**/src/**/__tests__/**/*.ts&#x27;</span>, <span class="string">&#x27;!**/src/**/__tests__/**/*.snap.test.ts&#x27;</span>],</span><br><span class="line"></span><br><span class="line">    <span class="attr">collectCoverage</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">collectCoverageFrom</span>: [<span class="string">&#x27;src/**/*.ts&#x27;</span>, <span class="string">&#x27;!src/**/*.snap.test.ts&#x27;</span>, <span class="string">&#x27;!src/index.ts&#x27;</span>],</span><br><span class="line">    <span class="attr">coverageDirectory</span>: <span class="string">&#x27;reports/jest&#x27;</span>,</span><br><span class="line">    <span class="attr">coverageThreshold</span>: &#123; <span class="attr">global</span>: &#123; <span class="attr">lines</span>: <span class="number">90</span>, <span class="attr">branches</span>: <span class="number">50</span> &#125; &#125;,</span><br><span class="line">    <span class="attr">coverageReporters</span>: [<span class="string">&#x27;html&#x27;</span>],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>在<code>jest.coverage.config.js</code>中，<code>testMatch</code>排除执行<code>.snap.test.ts</code>用例文件，<code>collectCoverageFrom</code>也排除了<code>.snap.test.ts</code>文件本身作为源码文件被收集的问题。</p>
<p>接下来，只需要把包含<code>toMatchSnapshot</code>等方法的测试用例，单独成文件且命名为<code>*.snap.test.ts</code>，就可以了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://taoliujun.github.io/blog/snapshot-impact-on-coverage/" data-id="clr63x2940000jcoi139y1gpg" data-title="snapshot对单测覆盖率的影响以及应对方案" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/jest/" rel="tag">jest</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-github-actions-sample-eslint-in-pull-request" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/github-actions-sample-eslint-in-pull-request/" class="article-date">
  <time class="dt-published" datetime="2023-12-28T19:56:49.000Z" itemprop="datePublished">2023-12-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/%E5%B7%A5%E7%A8%8B%E5%8C%96/">工程化</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/github-actions-sample-eslint-in-pull-request/">7. GitHub Actions - 在pull request中执行eslint检测的工作流例子</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>原文链接：<a target="_blank" rel="noopener" href="https://github.com/taoliujun/blog/issues/36">https://github.com/taoliujun/blog/issues/36</a></p>
<!--hexo
---
url: github-actions-sample-eslint-in-pull-request
tags:
  - github actions
---
-->

<p>一个在pull request发起的时候执行eslint检测的workflow，<a target="_blank" rel="noopener" href="https://github.com/taoliujun/npm-packages/blob/master/.github/workflows/check-pull-request.yml">点此查看完整代码</a>，它实现的功能如下：</p>
<ul>
<li>在pull request创建、更新的时候执行。</li>
<li>先回复一个评论，告诉用户正在运行。</li>
<li>初始化仓库，并安装依赖，产生依赖缓存。</li>
<li>运行eslint增量检查。</li>
<li>运行typescript检查。</li>
<li>运行jest检查。</li>
<li>更新之前的评论，回复检查的结果。</li>
</ul>
<p>运行截图：</p>
<p><img src="https://github.com/taoliujun/blog/assets/5689134/09c86bc1-ada1-41c3-9f8f-7e6c46f8204e" alt="Alt text"></p>
<p>为避免歧义，涉及到github action的术语都是英文的。术语介绍如下：</p>
<ul>
<li>workflow，工作流，可以理解为yml文件。</li>
<li>jobs，工作，一个workflow可以包含多个job，并行执行。</li>
<li>steps，作业，一个job可以包含多个step，串行执行。</li>
<li>action，操作，作业中具体的执行。</li>
</ul>
<h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/taoliujun/blog/issues/36#issuecomment-1871790603">初始化workflow</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/taoliujun/blog/issues/36#issuecomment-1871806576">reply checking</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/taoliujun/blog/issues/36#issuecomment-1871818126">.&#x2F;.github&#x2F;actions&#x2F;unique-comment</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/taoliujun/blog/issues/36#issuecomment-1871862632">init</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/taoliujun/blog/issues/36#issuecomment-1871862779">eslint</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/taoliujun/blog/issues/36#issuecomment-1871862850">typescript</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/taoliujun/blog/issues/36#issuecomment-1871863037">unit test</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/taoliujun/blog/issues/36#issuecomment-1871863117">reply result</a></li>
</ul>
<!--hexo-->

<h1 id="初始化workflow"><a href="#初始化workflow" class="headerlink" title="初始化workflow"></a>初始化workflow</h1><p>在项目中新建文件<code>.github/workflows/check-pull-request.yml</code>，内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">test</span> <span class="string">check</span> <span class="string">pull</span> <span class="string">request</span></span><br><span class="line"><span class="attr">run-name:</span> <span class="string">&#x27;check pull request #$<span class="template-variable">&#123;&#123; github.event.pull_request.number &#125;&#125;</span>&#x27;</span></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">    <span class="attr">pull_request:</span></span><br><span class="line">        <span class="attr">types:</span> [<span class="string">opened</span>, <span class="string">synchronize</span>, <span class="string">reopened</span>]</span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">    <span class="attr">replyChecking:</span></span><br><span class="line">        <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">        <span class="attr">steps:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">run:</span> <span class="string">echo</span> <span class="string">&#x27;replyChecking&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">init:</span></span><br><span class="line">        <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">        <span class="attr">steps:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">run:</span> <span class="string">echo</span> <span class="string">&#x27;init&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">eslint:</span></span><br><span class="line">        <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">        <span class="attr">needs:</span> [<span class="string">init</span>]</span><br><span class="line">        <span class="attr">steps:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">run:</span> <span class="string">echo</span> <span class="string">&#x27;eslint&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">typescript:</span></span><br><span class="line">        <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">        <span class="attr">needs:</span> [<span class="string">init</span>]</span><br><span class="line">        <span class="attr">steps:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">run:</span> <span class="string">echo</span> <span class="string">&#x27;typescript&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">unitTest:</span></span><br><span class="line">        <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">        <span class="attr">needs:</span> [<span class="string">init</span>]</span><br><span class="line">        <span class="attr">steps:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">run:</span> <span class="string">echo</span> <span class="string">&#x27;unitTest&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">replyResult:</span></span><br><span class="line">        <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">        <span class="attr">needs:</span> [<span class="string">replyChecking</span>, <span class="string">eslint</span>, <span class="string">typescript</span>, <span class="string">unitTest</span>]</span><br><span class="line">        <span class="attr">steps:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">run:</span> <span class="string">echo</span> <span class="string">&#x27;replyResult&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="name和run-name"><a href="#name和run-name" class="headerlink" title="name和run-name"></a>name和run-name</h2><p>给workflow命名为<code>check pull request</code>，它会出现在Actions页面的左侧菜单中。运行实例名为<code>check pull request #44</code>，出现在右侧的运行列表中。如图：</p>
<p><img src="https://github.com/taoliujun/blog/assets/5689134/c1371ff2-8fc3-4e5b-8b60-3c572419938b"></p>
<p><code>run-name</code>中的<code>$&#123;&#123; github.event.pull_request.number &#125;&#125;</code>是workflow的上下文，这里读取了上下文中的pr编号。</p>
<h2 id="on"><a href="#on" class="headerlink" title="on"></a>on</h2><p><code>on</code>指定了workflow的触发条件，这里配置了在pr创建、同步、重新打开的时候，触发该workflow。</p>
<h2 id="jobs"><a href="#jobs" class="headerlink" title="jobs"></a>jobs</h2><p>按照设想，需要定义几个job，分别是：</p>
<ul>
<li>replyChecking：回复用户正在检查中</li>
<li>init：初始化仓库，缓存依赖项</li>
<li>eslint：运行eslint检查</li>
<li>typescript：运行typescript检查</li>
<li>unitTest：运行单元测试</li>
<li>replyResult：回复用户检查结果</li>
</ul>
<p><code>jobs</code>是并行运行的，聪明如你肯定发现了，eslint、typescript、unitTest这三个job会涉及到安装npm依赖，所以它们最好在init后执行，确保依赖已经缓存了。</p>
<p>其次，replyResult肯定要拿到eslint等job的结果才能执行，所以使用了<code>needs</code>管理它们的执行依赖关系。</p>
<h3 id="runs-on"><a href="#runs-on" class="headerlink" title="runs-on"></a>runs-on</h3><p>每个job都运行在独立的容器中，github官方提供了windows、macos、linux多种容器，这里使用了ubuntu容器。</p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>发起一个pr，看到Actions页面出现了新的运行实例，点击进去，可以看到各个job的运行情况和依赖关系：</p>
<p><img src="https://github.com/taoliujun/blog/assets/5689134/09c86bc1-ada1-41c3-9f8f-7e6c46f8204e"></p>
<!--hexo-->

<h1 id="replyChecking"><a href="#replyChecking" class="headerlink" title="replyChecking"></a>replyChecking</h1><p>在进行eslint检测之前，先在pr里回复<code>checking</code>，并且带上拽酷炫的话。将replyChecking改成如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">replyChecking:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span></span><br><span class="line">          <span class="attr">uses:</span> <span class="string">actions/checkout@v4</span></span><br><span class="line">          <span class="attr">with:</span></span><br><span class="line">              <span class="attr">ref:</span> <span class="string">$&#123;&#123;github.head_ref&#125;&#125;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Get</span> <span class="string">date</span> <span class="string">time</span></span><br><span class="line">          <span class="attr">id:</span> <span class="string">getDateTime</span></span><br><span class="line">          <span class="attr">run:</span> <span class="string">echo</span> <span class="string">&quot;result=$(TZ=Asia/Shanghai date)&quot;</span> <span class="string">&gt;&gt;</span> <span class="string">&quot;$GITHUB_OUTPUT&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">or</span> <span class="string">update</span> <span class="string">a</span> <span class="string">comment</span></span><br><span class="line">          <span class="attr">uses:</span> <span class="string">./.github/actions/unique-comment</span></span><br><span class="line">          <span class="attr">with:</span></span><br><span class="line">              <span class="attr">uniqueIdentifier:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.workflow</span> <span class="string">&#125;&#125;</span></span><br><span class="line">              <span class="attr">body:</span> <span class="string">|</span></span><br><span class="line"><span class="string">                  **Checking...**</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">                  <span class="string">---</span></span><br><span class="line"></span><br><span class="line">                  <span class="string">Commented</span> <span class="string">by</span> <span class="string">Action</span> [<span class="string">$<span class="template-variable">&#123;&#123;github.workflow&#125;&#125;</span></span>]<span class="string">($&#123;&#123;github.event.repository.html_url&#125;&#125;/actions/runs/$&#123;&#123;github.run_id&#125;&#125;),</span> <span class="string">last</span> <span class="string">updated</span> <span class="string">on</span> <span class="string">$&#123;&#123;steps.getDateTime.outputs.result&#125;&#125;.</span></span><br></pre></td></tr></table></figure>

<p><code>steps</code>每一步里<code>name</code>、<code>id</code>是可选的，<code>name</code>在Actions详情页面里会显示，更直观的看到step的名称，推荐写上。</p>
<h2 id="Checkout"><a href="#Checkout" class="headerlink" title="Checkout"></a>Checkout</h2><p><code>uses</code>表示使用一个action，名为<code>actions/checkout@v4</code>，它用来拉取仓库。</p>
<blockquote>
<p>同其他编程语言一样，重复的action可以封装起来。<a target="_blank" rel="noopener" href="https://github.com/marketplace?type=actions">action市场</a>提供了很多。</p>
</blockquote>
<p><code>with</code>属性指定了该action的输入参数，每个action的参数不尽相同。</p>
<p><code>ref</code>参数表示要拉取的分支，<code>$&#123;&#123;github.head_ref&#125;&#125;</code>也是一个上下文，表示当前pr的源分支。</p>
<h2 id="Get-Date-time"><a href="#Get-Date-time" class="headerlink" title="Get Date time"></a>Get Date time</h2><p>这step还写了<code>id</code>，表示该step在该job中的唯一标识，为什么要写呢？是为了下一步step能根据<code>id</code>读取到它的<code>output</code>。</p>
<blockquote>
<p><strong>output</strong>是workflow中非常重要的概念，它用于在step之间、job之间分享简单的数据。</p>
</blockquote>
<p><code>run</code>就是在容器中跑一个命令，这里跑了一个unix bash命令，将当前时间写入到<code>$GITHUB_OUTPUT</code>中，键名为<code>result</code>。</p>
<blockquote>
<p><code>$GITHUB_OUTPUT</code>是workflow注入到容器中的一个路径，用于存放output。</p>
</blockquote>
<h2 id="Create-or-update-a-comment"><a href="#Create-or-update-a-comment" class="headerlink" title="Create or update a comment"></a>Create or update a comment</h2><p><code>uses</code>使用了本地的action，这个action用于创建或更新一个唯一回复，下一节说。</p>
<blockquote>
<p>有时候，官方或市场的action并不能满足你的需要，就得自己写一个了。</p>
</blockquote>
<p>同理，该action也有<code>with</code>属性，<code>uniqueIdentifier</code>是回复评论的唯一标识，<code>body</code>是回复的内容，内容使用了markdown语法，里面还涉及到上下文不一一细讲了。只说<code>$&#123;&#123;steps.getDateTime.outputs.result&#125;&#125;</code>这个上下文表示获取getDateTime这个step中，键名为<code>result</code>的值。</p>
<p>如果你不需要在内容里插入时间，那么上面的<code>Get Date time</code>就可以省略了。</p>
<h2 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h2><p>因为我已经有完整的代码了，所以运行后，pr中会有一个回复，如图：</p>
<p><img src="https://github.com/taoliujun/blog/assets/5689134/42396a84-b798-4f4e-9f39-5bf92a8acb15"></p>
<!--hexo-->

<h1 id="x2F-github-x2F-actions-x2F-unique-comment"><a href="#x2F-github-x2F-actions-x2F-unique-comment" class="headerlink" title=".&#x2F;.github&#x2F;actions&#x2F;unique-comment"></a>.&#x2F;.github&#x2F;actions&#x2F;unique-comment</h1><p>这是一个封装的javascript action，用于对issue创建、更新唯一评论。</p>
<h2 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h2><p>创建目录<code>./.github/actions/unique-comment</code>，最终目录结构如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── action.yml</span><br><span class="line">├── config</span><br><span class="line">│   └── webpack.config.js</span><br><span class="line">├── dist</span><br><span class="line">│   ├── index.js</span><br><span class="line">│   └── index.js.LICENSE.txt</span><br><span class="line">├── package.json</span><br><span class="line">└── src</span><br><span class="line">    └── index.js</span><br></pre></td></tr></table></figure>

<h2 id="action-yml"><a href="#action-yml" class="headerlink" title="action.yml"></a>action.yml</h2><p>这是action的配置文件，必须存在，内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">unique-comment</span></span><br><span class="line"><span class="attr">description:</span> <span class="string">create</span> <span class="string">or</span> <span class="string">update</span> <span class="string">a</span> <span class="string">unique</span> <span class="string">comment</span></span><br><span class="line"></span><br><span class="line"><span class="attr">runs:</span></span><br><span class="line">    <span class="attr">using:</span> <span class="string">&#x27;node20&#x27;</span></span><br><span class="line">    <span class="attr">main:</span> <span class="string">&#x27;./dist/index.js&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">inputs:</span></span><br><span class="line">    <span class="attr">token:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">&#x27;GitHub token&#x27;</span></span><br><span class="line">        <span class="attr">required:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">default:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.token</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">owner:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">&#x27;Repository owner&#x27;</span></span><br><span class="line">        <span class="attr">required:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">default:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.repository.owner.login</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">repo:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">&#x27;Repository name&#x27;</span></span><br><span class="line">        <span class="attr">required:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">default:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.repository.name</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">issue_number:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">&#x27;Issue number&#x27;</span></span><br><span class="line">        <span class="attr">required:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">default:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.number</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">body:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">&#x27;Comment body&#x27;</span></span><br><span class="line">        <span class="attr">required:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">uniqueIdentifier:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">&#x27;Unique identifier for comment&#x27;</span></span><br><span class="line">        <span class="attr">required:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">default:</span> <span class="string">&#x27;unique-comment&#x27;</span></span><br></pre></td></tr></table></figure>

<p>大部分属性不一一细讲了，都是简单的英文望文生义即可。</p>
<p><code>runs</code>表示运行在<code>node20</code>环境下，入口文件为<code>./dist/index.js</code>。</p>
<p><code>inputs</code>表示接受的参数，也就是之前提到的<code>with</code>属性里要输入的参数。用<code>required</code>表示是否必须传入，<code>default</code>表示默认值。</p>
<h2 id="src-x2F-index-js"><a href="#src-x2F-index-js" class="headerlink" title="src&#x2F;index.js"></a>src&#x2F;index.js</h2><p>为什么入口文件是<code>dist/index.js</code>，而不是<code>src/index.js</code>呢？因为要引用一些github官方提供的快捷操作github REST API的js包去操作issue评论(pull request也是一种issue)，最终打包后的文件才能在工作流中稳妥的运行。所以，写好<code>src/index.js</code>，再打包就行。</p>
<p>该文件代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> core = <span class="built_in">require</span>(<span class="string">&#x27;@actions/core&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> github = <span class="built_in">require</span>(<span class="string">&#x27;@actions/github&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">main</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> token = core.<span class="title function_">getInput</span>(<span class="string">&#x27;token&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> owner = core.<span class="title function_">getInput</span>(<span class="string">&#x27;owner&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> repo = core.<span class="title function_">getInput</span>(<span class="string">&#x27;repo&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> issueNumber = core.<span class="title function_">getInput</span>(<span class="string">&#x27;issue_number&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> uniqueIdentifier = <span class="string">`[^uniqueIdentifier]: <span class="subst">$&#123;core.getInput(<span class="string">&#x27;uniqueIdentifier&#x27;</span>)&#125;</span>`</span>;</span><br><span class="line">    <span class="keyword">const</span> body = <span class="string">`<span class="subst">$&#123;core.getInput(<span class="string">&#x27;body&#x27;</span>)&#125;</span>\n\n<span class="subst">$&#123;uniqueIdentifier&#125;</span>`</span>;</span><br><span class="line"></span><br><span class="line">    core.<span class="title function_">debug</span>(<span class="string">`uniqueIdentifier is <span class="subst">$&#123;uniqueIdentifier&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> octokit = github.<span class="title function_">getOctokit</span>(token);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> comments = <span class="keyword">await</span> octokit.<span class="property">rest</span>.<span class="property">issues</span>.<span class="title function_">listComments</span>(&#123;</span><br><span class="line">        owner,</span><br><span class="line">        repo,</span><br><span class="line">        <span class="attr">issue_number</span>: issueNumber,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> botComment = comments.<span class="property">data</span>.<span class="title function_">find</span>(<span class="function">(<span class="params">v</span>) =&gt;</span> v.<span class="property">body</span>.<span class="title function_">includes</span>(uniqueIdentifier));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (botComment) &#123;</span><br><span class="line">        core.<span class="title function_">info</span>(<span class="string">&#x27;update comment successfully.&#x27;</span>);</span><br><span class="line">        <span class="keyword">await</span> octokit.<span class="property">rest</span>.<span class="property">issues</span>.<span class="title function_">updateComment</span>(&#123;</span><br><span class="line">            owner,</span><br><span class="line">            repo,</span><br><span class="line">            <span class="attr">comment_id</span>: botComment.<span class="property">id</span>,</span><br><span class="line">            body,</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        core.<span class="title function_">info</span>(<span class="string">&#x27;create comment successfully.&#x27;</span>);</span><br><span class="line">        <span class="keyword">await</span> octokit.<span class="property">rest</span>.<span class="property">issues</span>.<span class="title function_">createComment</span>(&#123;</span><br><span class="line">            owner,</span><br><span class="line">            repo,</span><br><span class="line">            <span class="attr">issue_number</span>: issueNumber,</span><br><span class="line">            body,</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="title function_">main</span>();</span><br><span class="line">&#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    core.<span class="title function_">setFailed</span>(err.<span class="property">message</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>@actions/core</code>和<code>@actions/github</code>是github官方提供的js包，前者可以方便的读取入参等，后者可以方便的操作github REST API。</p>
<p><code>main</code>函数的代码就是原生javascript，不一一解释了，主要通过<code>uniqueIdentifier</code>来判断是否发布过评论，如果是，就更新评论，否则就创建评论。</p>
<blockquote>
<p>markdown语法<code>[^uniqueIdentifier]</code>表示脚注，不会被渲染。</p>
</blockquote>
<p><code>core.setFailed(err.message);</code>表示抛出退出代码。</p>
<h2 id="config-x2F-webpack-config-js"><a href="#config-x2F-webpack-config-js" class="headerlink" title="config&#x2F;webpack.config.js"></a>config&#x2F;webpack.config.js</h2><p>打包用的，配置简单可用即可：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    <span class="attr">mode</span>: <span class="string">&#x27;production&#x27;</span>,</span><br><span class="line">    <span class="attr">target</span>: <span class="string">&#x27;node20&#x27;</span>,</span><br><span class="line">    <span class="attr">entry</span>: <span class="string">&#x27;./src/index.js&#x27;</span>,</span><br><span class="line">    <span class="attr">output</span>: &#123;</span><br><span class="line">        <span class="attr">filename</span>: <span class="string">&#x27;index.js&#x27;</span>,</span><br><span class="line">        <span class="attr">clean</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="package-json"><a href="#package-json" class="headerlink" title="package.json"></a>package.json</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;unique-comment&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;private&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span> <span class="string">&quot;webpack --config ./config/webpack.config.js&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;dependencies&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@actions/core&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^1.10.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;@actions/github&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^6.0.0&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;devDependencies&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;webpack&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^5.89.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;webpack-cli&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^5.1.4&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>没啥好说的，列出了依赖项。和一个打包脚本。</p>
<h2 id="测试-2"><a href="#测试-2" class="headerlink" title="测试"></a>测试</h2><p>修改了<code>src/index.js</code>得<code>build</code>，然后push到github仓库。</p>
<p>记得将<strong>dist</strong>目录也提交到github仓库。</p>
<!--hexo-->

<h1 id="init"><a href="#init" class="headerlink" title="init"></a>init</h1><p>现在，开始搞正经的了。</p>
<p>先初始化项目，这个job的目的仅仅是为了缓存pnpm依赖项，如果你的项目的依赖项不经常更新，可以省略这个job，后续也不要<code>needs</code>这个job。</p>
<p>将init改成如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">init:</span></span><br><span class="line">        <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">        <span class="attr">steps:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Init</span> <span class="string">repo</span></span><br><span class="line">              <span class="attr">uses:</span> <span class="string">actions/checkout@v4</span></span><br><span class="line">              <span class="attr">with:</span></span><br><span class="line">                  <span class="attr">ref:</span> <span class="string">$&#123;&#123;github.head_ref&#125;&#125;</span></span><br><span class="line"></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Init</span> <span class="string">pnpm</span></span><br><span class="line">              <span class="attr">uses:</span> <span class="string">pnpm/action-setup@v2</span></span><br><span class="line">              <span class="attr">with:</span></span><br><span class="line">                  <span class="attr">version:</span> <span class="number">8</span></span><br><span class="line"></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Init</span> <span class="string">node</span></span><br><span class="line">              <span class="attr">uses:</span> <span class="string">actions/setup-node@v4</span></span><br><span class="line">              <span class="attr">with:</span></span><br><span class="line">                  <span class="attr">node-version:</span> <span class="number">20</span></span><br><span class="line">                  <span class="attr">cache:</span> <span class="string">&#x27;pnpm&#x27;</span></span><br><span class="line"></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">dependencies</span></span><br><span class="line">              <span class="attr">run:</span> <span class="string">pnpm</span> <span class="string">install</span></span><br></pre></td></tr></table></figure>

<p>相信经过对之前的job的了解，这里的配置就看起来很简单了。</p>
<h2 id="Init-pnpm"><a href="#Init-pnpm" class="headerlink" title="Init pnpm"></a>Init pnpm</h2><p>使用第三方action，安装pnpm@^8。</p>
<h2 id="Init-node"><a href="#Init-node" class="headerlink" title="Init node"></a>Init node</h2><p><code>cache: &#39;pnpm&#39;</code>指定缓存机制，它内部是利用了workflow的cache机制。</p>
<h2 id="Install-dependencies"><a href="#Install-dependencies" class="headerlink" title="Install dependencies"></a>Install dependencies</h2><p>安装依赖项，触发缓存。</p>
<!--hexo-->

<h1 id="eslint"><a href="#eslint" class="headerlink" title="eslint"></a>eslint</h1><p>将eslint改成如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eslint:</span></span><br><span class="line">        <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">        <span class="attr">needs:</span> [<span class="string">init</span>]</span><br><span class="line">        <span class="attr">outputs:</span></span><br><span class="line">            <span class="attr">result:</span> <span class="string">$&#123;&#123;</span> <span class="string">steps.lint.outputs.result</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">steps:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Init</span> <span class="string">repo</span></span><br><span class="line">              <span class="attr">uses:</span> <span class="string">actions/checkout@v4</span></span><br><span class="line">              <span class="attr">with:</span></span><br><span class="line">                  <span class="attr">ref:</span> <span class="string">$&#123;&#123;github.head_ref&#125;&#125;</span></span><br><span class="line">                  <span class="attr">fetch-depth:</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Init</span> <span class="string">pnpm</span></span><br><span class="line">              <span class="attr">uses:</span> <span class="string">pnpm/action-setup@v2</span></span><br><span class="line">              <span class="attr">with:</span></span><br><span class="line">                  <span class="attr">version:</span> <span class="number">8</span></span><br><span class="line"></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Init</span> <span class="string">node</span></span><br><span class="line">              <span class="attr">uses:</span> <span class="string">actions/setup-node@v4</span></span><br><span class="line">              <span class="attr">with:</span></span><br><span class="line">                  <span class="attr">node-version:</span> <span class="number">20</span></span><br><span class="line">                  <span class="attr">cache:</span> <span class="string">&#x27;pnpm&#x27;</span></span><br><span class="line"></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">dependencies</span></span><br><span class="line">              <span class="attr">run:</span> <span class="string">pnpm</span> <span class="string">install</span></span><br><span class="line"></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Run</span> <span class="string">eslint</span></span><br><span class="line">              <span class="attr">id:</span> <span class="string">lint</span></span><br><span class="line">              <span class="attr">uses:</span> <span class="string">actions/github-script@v7</span></span><br><span class="line">              <span class="attr">with:</span></span><br><span class="line">                  <span class="attr">result-encoding:</span> <span class="string">string</span></span><br><span class="line">                  <span class="attr">script:</span> <span class="string">|</span></span><br><span class="line"><span class="string">                      let output = &#x27;&#x27;;</span></span><br><span class="line"><span class="string">                      let outerr = &#x27;&#x27;;</span></span><br><span class="line"><span class="string">                      let diffFiles = &#x27;&#x27;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">                      <span class="string">await</span> <span class="string">exec.exec(</span></span><br><span class="line">                        <span class="string">`git</span> <span class="string">diff</span> <span class="string">--name-only</span> <span class="string">origin/$&#123;&#123;github.base_ref&#125;&#125;`,</span></span><br><span class="line">                        []<span class="string">,</span></span><br><span class="line">                        &#123;</span><br><span class="line">                          <span class="string">//</span> <span class="attr">silent:</span> <span class="literal">true</span>,</span><br><span class="line">                          <span class="string">//</span> <span class="attr">ignoreReturnCode:</span> <span class="literal">true</span>,</span><br><span class="line">                          <span class="attr">listeners:</span> &#123;</span><br><span class="line">                            <span class="attr">stdout:</span> <span class="string">(data)</span> <span class="string">=&gt;</span> &#123;</span><br><span class="line">                                <span class="string">diffFiles</span> <span class="string">+=</span> <span class="string">data.toString();</span></span><br><span class="line">                            &#125;,</span><br><span class="line">                          &#125;,</span><br><span class="line">                        &#125;</span><br><span class="line">                      <span class="string">);</span></span><br><span class="line"></span><br><span class="line">                      <span class="string">const</span> <span class="string">lintFiles</span> <span class="string">=</span> <span class="string">diffFiles.split(`\n`).filter((file)</span> <span class="string">=&gt;</span> &#123;</span><br><span class="line">                        <span class="string">return</span> <span class="string">file.endsWith(&#x27;.js&#x27;)</span> <span class="string">||</span> <span class="string">file.endsWith(&#x27;.ts&#x27;)</span> <span class="string">||</span> <span class="string">file.endsWith(&#x27;.tsx&#x27;)</span></span><br><span class="line">                      &#125;<span class="string">).join(&#x27;</span> <span class="string">&#x27;);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                      await exec.exec(</span></span><br><span class="line"><span class="string">                        // &quot;pnpm run lint --format stylish&quot;,</span></span><br><span class="line"><span class="string">                        `pnpm eslint $&#123;lintFiles&#125;`,</span></span><br><span class="line"><span class="string">                        [],</span></span><br><span class="line"><span class="string">                        &#123;</span></span><br><span class="line"><span class="string">                          // silent: true,</span></span><br><span class="line"><span class="string">                          ignoreReturnCode: true,</span></span><br><span class="line"><span class="string">                          listeners: &#123;</span></span><br><span class="line"><span class="string">                            stdout: (data) =&gt; &#123;</span></span><br><span class="line"><span class="string">                                output += data.toString();</span></span><br><span class="line"><span class="string">                            &#125;,</span></span><br><span class="line"><span class="string">                            stderr: (data) =&gt; &#123;</span></span><br><span class="line"><span class="string">                                outerr += data.toString();</span></span><br><span class="line"><span class="string">                            &#125;,</span></span><br><span class="line"><span class="string">                          &#125;,</span></span><br><span class="line"><span class="string">                        &#125;</span></span><br><span class="line"><span class="string">                      );</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                      if (outerr) &#123;</span></span><br><span class="line"><span class="string">                        return `:x: Some command execution errors, non-eslint business errors.`;</span></span><br><span class="line"><span class="string">                      &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                      const errorMatch = output.match(/(\d+) errors?/);</span></span><br><span class="line"><span class="string">                      const warnMatch = output.match(/(\d+) warnings?/);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                      if (errorMatch &amp;&amp; errorMatch?.[1] !== &#x27;</span><span class="number">0</span><span class="string">&#x27;) &#123;</span></span><br><span class="line"><span class="string">                        return `:x: $&#123;errorMatch?.[0]&#125; $&#123;warnMatch?.[0]&#125;`;</span></span><br><span class="line"><span class="string">                      &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                      return `:white_check_mark: $&#123;errorMatch?.[0] || &#x27;</span><span class="number">0</span> <span class="string">error&#x27;&#125;</span> <span class="string">$&#123;warnMatch?.[0]</span> <span class="string">||</span> <span class="string">&#x27;0 warning&#x27;</span><span class="string">&#125;`;</span></span><br></pre></td></tr></table></figure>

<h2 id="needs"><a href="#needs" class="headerlink" title="needs"></a>needs</h2><p>使用<code>needs</code>依赖init，可以使用到pnpm的缓存项，防止install太慢。</p>
<blockquote>
<p>因为eslint、typescript、unitTest都需要pnpm install，所以一个前置的init去缓存pnpm依赖项，可以加快后续的install速度。</p>
</blockquote>
<h2 id="outputs"><a href="#outputs" class="headerlink" title="outputs"></a>outputs</h2><p>job里的outputs，可以在依赖它的其他job中访问到。这里使用<code>$&#123;&#123; steps.lint.outputs.result &#125;&#125;</code>去获取该job中lint这个step里的output里的result。</p>
<blockquote>
<p>output有job和step两个维度，注意区分。</p>
</blockquote>
<h2 id="Run-eslint"><a href="#Run-eslint" class="headerlink" title="Run eslint"></a>Run eslint</h2><p>它uses了<code>actions/github-script@v7</code>，这是github官方提供的一个action，可以在<code>with.script</code>里写js代码去执行，同时它会注入一些变量到script中去，见它的<a target="_blank" rel="noopener" href="https://github.com/actions/github-script/tree/v7/">官方文档</a>。</p>
<blockquote>
<p>对于简单的js代码，可以使用这个action去完成，不用再去写一个js文件。</p>
</blockquote>
<p><code>result-encoding</code>是指定script返回的数据格式的，默认是json，这指定为string。</p>
<blockquote>
<p>为什么script里return了string，还要指定为string呢？<br>因为<code>return &#39;hello&#39;</code>在json encode后是<code>&#39;&quot;hello&quot;&#39;</code>，而string encode后为<code>&#39;hello&#39;</code>。</p>
</blockquote>
<p>script里是原生的js代码了，里面的<code>exec</code>是该action注入的变量，用来执行shell命令。</p>
<p>这段js代码做了两个事情，一是<code>git diff</code>获取pr中改动的文件列表，二是<code>eslint</code>检查这些增量文件，最后返回处理的结果。</p>
<h2 id="fetch-depth"><a href="#fetch-depth" class="headerlink" title="fetch-depth"></a>fetch-depth</h2><p>Init repo这个step里设置了<code>fetch-depth: 0</code>，不然获取不到完整的git分支，具体看<code>actions/checkout</code>的解释，涉及到git的知识不展开细说了。</p>
<h2 id="steps-lint-outputs-result"><a href="#steps-lint-outputs-result" class="headerlink" title="steps.lint.outputs.result"></a>steps.lint.outputs.result</h2><p><code>steps.lint.outputs.result</code>为什么能拿到lint step里的output.result呢？因为<code>actions/github-script</code>这个action内部将script的返回值，设置到<code>$GITHUB_OUTPUT</code>里了，且键名为<code>result</code>。</p>
<!--hexo-->

<h1 id="typescript"><a href="#typescript" class="headerlink" title="typescript"></a>typescript</h1><p>和eslint的配置大同小异，只是改了对检测结果的判断。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">typescript:</span></span><br><span class="line">        <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">        <span class="attr">needs:</span> [<span class="string">init</span>]</span><br><span class="line">        <span class="attr">outputs:</span></span><br><span class="line">            <span class="attr">result:</span> <span class="string">$&#123;&#123;</span> <span class="string">steps.lint.outputs.result</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">steps:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Init</span> <span class="string">repo</span></span><br><span class="line">              <span class="attr">uses:</span> <span class="string">actions/checkout@v4</span></span><br><span class="line">              <span class="attr">with:</span></span><br><span class="line">                  <span class="attr">ref:</span> <span class="string">$&#123;&#123;github.head_ref&#125;&#125;</span></span><br><span class="line"></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Init</span> <span class="string">pnpm</span></span><br><span class="line">              <span class="attr">uses:</span> <span class="string">pnpm/action-setup@v2</span></span><br><span class="line">              <span class="attr">with:</span></span><br><span class="line">                  <span class="attr">version:</span> <span class="number">8</span></span><br><span class="line"></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Init</span> <span class="string">node</span></span><br><span class="line">              <span class="attr">uses:</span> <span class="string">actions/setup-node@v4</span></span><br><span class="line">              <span class="attr">with:</span></span><br><span class="line">                  <span class="attr">node-version:</span> <span class="number">20</span></span><br><span class="line">                  <span class="attr">cache:</span> <span class="string">&#x27;pnpm&#x27;</span></span><br><span class="line"></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">dependencies</span></span><br><span class="line">              <span class="attr">run:</span> <span class="string">pnpm</span> <span class="string">install</span></span><br><span class="line"></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Run</span> <span class="string">lint</span></span><br><span class="line">              <span class="attr">id:</span> <span class="string">lint</span></span><br><span class="line">              <span class="attr">uses:</span> <span class="string">actions/github-script@v7</span></span><br><span class="line">              <span class="attr">with:</span></span><br><span class="line">                  <span class="attr">result-encoding:</span> <span class="string">string</span></span><br><span class="line">                  <span class="attr">script:</span> <span class="string">|</span></span><br><span class="line"><span class="string">                      let output = &#x27;&#x27;;</span></span><br><span class="line"><span class="string">                      let outerr = &#x27;&#x27;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">                      <span class="string">await</span> <span class="string">exec.exec(</span></span><br><span class="line">                        <span class="string">`pnpm</span> <span class="string">run</span> <span class="string">-r</span> <span class="string">lint:ts`,</span></span><br><span class="line">                        []<span class="string">,</span></span><br><span class="line">                        &#123;</span><br><span class="line">                          <span class="string">//</span> <span class="attr">silent:</span> <span class="literal">true</span>,</span><br><span class="line">                          <span class="attr">ignoreReturnCode:</span> <span class="literal">true</span>,</span><br><span class="line">                          <span class="attr">listeners:</span> &#123;</span><br><span class="line">                            <span class="attr">stdout:</span> <span class="string">(data)</span> <span class="string">=&gt;</span> &#123;</span><br><span class="line">                                <span class="string">output</span> <span class="string">+=</span> <span class="string">data.toString();</span></span><br><span class="line">                            &#125;,</span><br><span class="line">                            <span class="attr">stderr:</span> <span class="string">(data)</span> <span class="string">=&gt;</span> &#123;</span><br><span class="line">                                <span class="string">outerr</span> <span class="string">+=</span> <span class="string">data.toString();</span></span><br><span class="line">                            &#125;,</span><br><span class="line">                          &#125;,</span><br><span class="line">                        &#125;</span><br><span class="line">                      <span class="string">);</span></span><br><span class="line"></span><br><span class="line">                      <span class="string">if</span> <span class="string">(outerr)</span> &#123;</span><br><span class="line">                        <span class="string">return</span> <span class="string">`:x:</span> <span class="string">Some</span> <span class="string">command</span> <span class="string">execution</span> <span class="string">errors</span>, <span class="literal">no</span> <span class="string">business</span> <span class="string">errors.`;</span></span><br><span class="line">                      &#125;</span><br><span class="line"></span><br><span class="line">                      <span class="string">const</span> <span class="string">errorMatch</span> <span class="string">=</span> <span class="string">output.match(/error</span> <span class="string">TS/g);</span></span><br><span class="line"></span><br><span class="line">                      <span class="string">if</span> <span class="string">(errorMatch)</span> &#123;</span><br><span class="line">                        <span class="string">return</span> <span class="string">`:x:</span> <span class="string">$</span>&#123;<span class="string">errorMatch?.length</span>&#125; <span class="string">errors`;</span></span><br><span class="line">                      &#125;</span><br><span class="line"></span><br><span class="line">                      <span class="string">return</span> <span class="string">`:white_check_mark:</span> <span class="string">$&#123;&#x27;0</span> <span class="string">error&#x27;&#125;`;</span></span><br></pre></td></tr></table></figure>
<!--hexo-->

<h1 id="unitTest"><a href="#unitTest" class="headerlink" title="unitTest"></a>unitTest</h1><p>和eslint的配置大同小异，只是改了对检测结果的判断。唯一的区别是jest的检测结果是输出到stderr，见<a target="_blank" rel="noopener" href="https://github.com/jestjs/jest/issues/5064%E3%80%82">https://github.com/jestjs/jest/issues/5064。</a></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">unitTest:</span></span><br><span class="line">        <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">        <span class="attr">needs:</span> [<span class="string">init</span>]</span><br><span class="line">        <span class="attr">outputs:</span></span><br><span class="line">            <span class="attr">result:</span> <span class="string">$&#123;&#123;</span> <span class="string">steps.lint.outputs.result</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">steps:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Init</span> <span class="string">repo</span></span><br><span class="line">              <span class="attr">uses:</span> <span class="string">actions/checkout@v4</span></span><br><span class="line">              <span class="attr">with:</span></span><br><span class="line">                  <span class="attr">ref:</span> <span class="string">$&#123;&#123;github.head_ref&#125;&#125;</span></span><br><span class="line"></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Init</span> <span class="string">pnpm</span></span><br><span class="line">              <span class="attr">uses:</span> <span class="string">pnpm/action-setup@v2</span></span><br><span class="line">              <span class="attr">with:</span></span><br><span class="line">                  <span class="attr">version:</span> <span class="number">8</span></span><br><span class="line"></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Init</span> <span class="string">node</span></span><br><span class="line">              <span class="attr">uses:</span> <span class="string">actions/setup-node@v4</span></span><br><span class="line">              <span class="attr">with:</span></span><br><span class="line">                  <span class="attr">node-version:</span> <span class="number">20</span></span><br><span class="line">                  <span class="attr">cache:</span> <span class="string">&#x27;pnpm&#x27;</span></span><br><span class="line"></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">dependencies</span></span><br><span class="line">              <span class="attr">run:</span> <span class="string">pnpm</span> <span class="string">install</span></span><br><span class="line"></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Run</span> <span class="string">lint</span></span><br><span class="line">              <span class="attr">id:</span> <span class="string">lint</span></span><br><span class="line">              <span class="attr">uses:</span> <span class="string">actions/github-script@v7</span></span><br><span class="line">              <span class="attr">with:</span></span><br><span class="line">                  <span class="attr">result-encoding:</span> <span class="string">string</span></span><br><span class="line">                  <span class="attr">script:</span> <span class="string">|</span></span><br><span class="line"><span class="string">                      let output = &#x27;&#x27;;</span></span><br><span class="line"><span class="string">                      let outerr = &#x27;&#x27;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">                      <span class="string">await</span> <span class="string">exec.exec(</span></span><br><span class="line">                        <span class="string">`pnpm</span> <span class="string">run</span> <span class="string">test`,</span></span><br><span class="line">                        []<span class="string">,</span></span><br><span class="line">                        &#123;</span><br><span class="line">                          <span class="string">//</span> <span class="attr">silent:</span> <span class="literal">true</span>,</span><br><span class="line">                          <span class="attr">ignoreReturnCode:</span> <span class="literal">true</span>,</span><br><span class="line">                          <span class="attr">listeners:</span> &#123;</span><br><span class="line">                            <span class="attr">stdout:</span> <span class="string">(data)</span> <span class="string">=&gt;</span> &#123;</span><br><span class="line">                                <span class="string">output</span> <span class="string">+=</span> <span class="string">data.toString();</span></span><br><span class="line">                            &#125;,</span><br><span class="line">                            <span class="attr">stderr:</span> <span class="string">(data)</span> <span class="string">=&gt;</span> &#123;</span><br><span class="line">                                <span class="string">outerr</span> <span class="string">+=</span> <span class="string">data.toString();</span></span><br><span class="line">                            &#125;,</span><br><span class="line">                          &#125;,</span><br><span class="line">                        &#125;</span><br><span class="line">                      <span class="string">);</span></span><br><span class="line"></span><br><span class="line">                      <span class="string">//</span> <span class="string">why</span> <span class="string">use</span> <span class="string">outerr?</span> <span class="string">https://github.com/jestjs/jest/issues/5064</span></span><br><span class="line"></span><br><span class="line">                      <span class="string">const</span> <span class="string">failMatch</span> <span class="string">=</span> <span class="string">outerr.match(/Test</span> <span class="attr">Suites:</span> <span class="string">\d+</span> <span class="string">failed/);</span></span><br><span class="line"></span><br><span class="line">                      <span class="string">if</span> <span class="string">(failMatch)</span> &#123;</span><br><span class="line">                        <span class="string">return</span> <span class="string">`:x:</span> <span class="string">$</span>&#123;<span class="string">failMatch?.</span>[<span class="number">0</span>]&#125;<span class="string">`;</span></span><br><span class="line">                      &#125;</span><br><span class="line"></span><br><span class="line">                      <span class="string">const</span> <span class="string">errorMatch</span> <span class="string">=</span> <span class="string">outerr.match(/Jest:</span> <span class="string">&quot;global&quot;</span> <span class="string">coverage</span> <span class="string">threshold</span> <span class="string">for</span> <span class="string">lines</span> <span class="string">\([0-9\.]+%\)</span> <span class="attr">not met:</span> [<span class="number">0</span><span class="number">-9</span><span class="string">\.</span>]<span class="string">+%/);</span></span><br><span class="line"></span><br><span class="line">                      <span class="string">if</span> <span class="string">(errorMatch)</span> &#123;</span><br><span class="line">                        <span class="string">return</span> <span class="string">`:x:</span> <span class="string">$</span>&#123;<span class="string">errorMatch?.</span>[<span class="number">0</span>]&#125;<span class="string">`;</span></span><br><span class="line">                      &#125;</span><br><span class="line"></span><br><span class="line">                      <span class="string">return</span> <span class="string">`:white_check_mark:</span> <span class="string">passed`;</span></span><br></pre></td></tr></table></figure>
<!--hexo-->

<h1 id="replyResult"><a href="#replyResult" class="headerlink" title="replyResult"></a>replyResult</h1><p>最后，将几个检测的结果进行汇总，回复到pr里就行了。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">replyResult:</span></span><br><span class="line">        <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">        <span class="attr">needs:</span> [<span class="string">replyChecking</span>, <span class="string">eslint</span>, <span class="string">typescript</span>, <span class="string">unitTest</span>]</span><br><span class="line">        <span class="attr">steps:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span></span><br><span class="line">              <span class="attr">uses:</span> <span class="string">actions/checkout@v4</span></span><br><span class="line">              <span class="attr">with:</span></span><br><span class="line">                  <span class="attr">ref:</span> <span class="string">$&#123;&#123;github.head_ref&#125;&#125;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Get</span> <span class="string">date</span> <span class="string">time</span></span><br><span class="line">              <span class="attr">id:</span> <span class="string">getDateTime</span></span><br><span class="line">              <span class="attr">run:</span> <span class="string">echo</span> <span class="string">&quot;result=$(TZ=Asia/Shanghai date)&quot;</span> <span class="string">&gt;&gt;</span> <span class="string">&quot;$GITHUB_OUTPUT&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">or</span> <span class="string">update</span> <span class="string">a</span> <span class="string">comment</span></span><br><span class="line">              <span class="attr">uses:</span> <span class="string">./.github/actions/unique-comment</span></span><br><span class="line">              <span class="attr">with:</span></span><br><span class="line">                  <span class="attr">uniqueIdentifier:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.workflow</span> <span class="string">&#125;&#125;</span></span><br><span class="line">                  <span class="attr">body:</span> <span class="string">|</span></span><br><span class="line"><span class="string">                      ## Eslint Check Result</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">                      <span class="string">$&#123;&#123;needs.eslint.outputs.result&#125;&#125;</span></span><br><span class="line"></span><br><span class="line">                      <span class="comment">## Typescript Check Result</span></span><br><span class="line"></span><br><span class="line">                      <span class="string">$&#123;&#123;needs.typescript.outputs.result&#125;&#125;</span></span><br><span class="line"></span><br><span class="line">                      <span class="comment">## UnitTest Check Result</span></span><br><span class="line"></span><br><span class="line">                      <span class="string">$&#123;&#123;needs.unitTest.outputs.result&#125;&#125;</span></span><br><span class="line"></span><br><span class="line">                      <span class="string">---</span></span><br><span class="line"></span><br><span class="line">                      <span class="string">Commented</span> <span class="string">by</span> <span class="string">Action</span> [<span class="string">$<span class="template-variable">&#123;&#123;github.workflow&#125;&#125;</span></span>]<span class="string">($&#123;&#123;github.event.repository.html_url&#125;&#125;/actions/runs/$&#123;&#123;github.run_id&#125;&#125;),</span> <span class="string">last</span> <span class="string">updated</span> <span class="string">on</span> <span class="string">$&#123;&#123;steps.getDateTime.outputs.result&#125;&#125;.</span></span><br></pre></td></tr></table></figure>

<p>和replyChecking差不多，在body里使用<code>$&#123;&#123;needs.eslint.outputs.result&#125;&#125;</code>去读取了eslint job的outputs。</p>
<h2 id="测试-3"><a href="#测试-3" class="headerlink" title="测试"></a>测试</h2><p>去发起新的pr，故意提交一个有eslint error的js&#x2F;ts文件，看看表现吧~</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://taoliujun.github.io/blog/github-actions-sample-eslint-in-pull-request/" data-id="clqxk9r600000joor84vf3yg8" data-title="7. GitHub Actions - 在pull request中执行eslint检测的工作流例子" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/github-actions/" rel="tag">github actions</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-react-zustand" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/react-zustand/" class="article-date">
  <time class="dt-published" datetime="2023-12-12T22:46:26.000Z" itemprop="datePublished">2023-12-13</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/React/">React</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/react-zustand/">React公共状态利器 - Zustand</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>原文链接：<a target="_blank" rel="noopener" href="https://github.com/taoliujun/blog/issues/35">https://github.com/taoliujun/blog/issues/35</a></p>
<!--hexo
---
url: react-zustand
tags:
  - zustand
  - react store
---
-->

<p>官方文档：<a target="_blank" rel="noopener" href="https://docs.pmnd.rs/zustand">https://docs.pmnd.rs/zustand</a></p>
<h1 id="如何使用"><a href="#如何使用" class="headerlink" title="如何使用"></a>如何使用</h1><p><strong>Zustand</strong> 是一个非常简单粗暴的全局状态管理库，它的使用有多简单呢？如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; pnpm add zustand</span><br></pre></td></tr></table></figure>

<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// useFormStateStore.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; create &#125; <span class="keyword">from</span> <span class="string">&#x27;zustand&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">State</span> &#123;</span><br><span class="line">    <span class="attr">loading</span>: <span class="built_in">boolean</span>;</span><br><span class="line">    <span class="attr">disabled</span>: <span class="built_in">boolean</span>;</span><br><span class="line">    <span class="attr">setLoadingByAge</span>: <span class="function">(<span class="params">value: <span class="built_in">number</span></span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useFormStateStore = create&lt;<span class="title class_">State</span>&gt;(<span class="function">(<span class="params">set</span>) =&gt;</span> (&#123;</span><br><span class="line">    <span class="attr">loading</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">disabled</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">setLoadingByAge</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">set</span>(&#123; <span class="attr">loading</span>: value &gt; <span class="number">10</span> &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>

<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.tsx</span></span><br><span class="line"><span class="keyword">import</span> &#123; useState, <span class="keyword">type</span> <span class="variable constant_">FC</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; useFormStateStore &#125; <span class="keyword">from</span> <span class="string">&#x27;./useFormStateStore&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Button</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@/components/Button&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Loading</span>: <span class="variable constant_">FC</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; loading &#125; = <span class="title function_">useFormStateStore</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>loading: &#123;String(loading)&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Disabled</span>: <span class="variable constant_">FC</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; disabled &#125; = <span class="title function_">useFormStateStore</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>disabled: &#123;String(disabled)&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Main</span>: <span class="variable constant_">FC</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; setLoadingByAge &#125; = <span class="title function_">useFormStateStore</span>();</span><br><span class="line">    <span class="keyword">const</span> [age, setAge] = <span class="title function_">useState</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Loading</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">br</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Disabled</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">br</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Button</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-xml">                    useFormStateStore.setState(&#123;</span></span><br><span class="line"><span class="language-xml">                        loading: true,</span></span><br><span class="line"><span class="language-xml">                    &#125;);</span></span><br><span class="line"><span class="language-xml">                &#125;&#125;</span></span><br><span class="line"><span class="language-xml">            &gt;</span></span><br><span class="line"><span class="language-xml">                set loading true</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Button</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-xml">                    useFormStateStore.setState(&#123;</span></span><br><span class="line"><span class="language-xml">                        loading: false,</span></span><br><span class="line"><span class="language-xml">                    &#125;);</span></span><br><span class="line"><span class="language-xml">                &#125;&#125;</span></span><br><span class="line"><span class="language-xml">            &gt;</span></span><br><span class="line"><span class="language-xml">                set loading false</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Button</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-xml">                    useFormStateStore.setState(&#123;</span></span><br><span class="line"><span class="language-xml">                        disabled: true,</span></span><br><span class="line"><span class="language-xml">                    &#125;);</span></span><br><span class="line"><span class="language-xml">                &#125;&#125;</span></span><br><span class="line"><span class="language-xml">            &gt;</span></span><br><span class="line"><span class="language-xml">                set disabled true</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Button</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-xml">                    useFormStateStore.setState(&#123;</span></span><br><span class="line"><span class="language-xml">                        disabled: false,</span></span><br><span class="line"><span class="language-xml">                    &#125;);</span></span><br><span class="line"><span class="language-xml">                &#125;&#125;</span></span><br><span class="line"><span class="language-xml">            &gt;</span></span><br><span class="line"><span class="language-xml">                set disabled false</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">br</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">input</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">type</span>=<span class="string">&quot;number&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">value</span>=<span class="string">&#123;age&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">onChange</span>=<span class="string">&#123;(e)</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-xml">                    setAge(Number(e.target.value));</span></span><br><span class="line"><span class="language-xml">                &#125;&#125;</span></span><br><span class="line"><span class="language-xml">            /&gt;</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">br</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Button</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-xml">                    setLoadingByAge(age);</span></span><br><span class="line"><span class="language-xml">                &#125;&#125;</span></span><br><span class="line"><span class="language-xml">            &gt;</span></span><br><span class="line"><span class="language-xml">                set loading by age</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">Main</span>;</span><br></pre></td></tr></table></figure>

<p>在<code>useFormStateStore.ts</code>中定义了状态，然后在<code>app.tsx</code>中使用，就是这么简单粗暴！这里有几点介绍下：</p>
<ul>
<li><p>对于简单的状态更新，使用<code>setState</code>方法就可以，它的参数是一个对象，这个对象就是你要更新的状态，它会和之前的状态进行合并，然后返回一个新的状态，从而触发组件更新。</p>
</li>
<li><p>对于需要通用的逻辑处理的状态更新，参照<code>useFormStateStore.ts</code>中的<code>setLoadingByAge</code>方法，将它作为状态里的一个方法就行了。</p>
</li>
</ul>
<h1 id="Zustand"><a href="#Zustand" class="headerlink" title="Zustand"></a>Zustand</h1><p>使用非常简单，API也很少，它的原理是使用了<code>Proxy</code>，所以它的性能非常好。</p>
<h1 id="相比Redux"><a href="#相比Redux" class="headerlink" title="相比Redux"></a>相比Redux</h1><p>相比Redux，Zustand的代码非常简单明了，不需要使用<code>connect</code>、<code>mapStateToProps</code>、<code>mapDispatchToProps</code>这些方法。</p>
<h1 id="相比React-Context"><a href="#相比React-Context" class="headerlink" title="相比React Context"></a>相比React Context</h1><p>React Context需要一个<code>Provider</code>包裹组件以传递状态，需要一个<code>useContext</code>使用状态，光从层级上就让人绕起来了。而Zustand只需要一个<code>create</code>方法，就可以使用了，且状态是全局的，不需要传递。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://taoliujun.github.io/blog/react-zustand/" data-id="clqxk9r640001joorghsabmh1" data-title="React公共状态利器 - Zustand" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/react-store/" rel="tag">react store</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/zustand/" rel="tag">zustand</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-changesets-in-monorepo" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/changesets-in-monorepo/" class="article-date">
  <time class="dt-published" datetime="2023-12-08T01:44:30.000Z" itemprop="datePublished">2023-12-08</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/%E5%B7%A5%E7%A8%8B%E5%8C%96/">工程化</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/changesets-in-monorepo/">在monorepo中使用changesets</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>原文链接：<a target="_blank" rel="noopener" href="https://github.com/taoliujun/blog/issues/33">https://github.com/taoliujun/blog/issues/33</a></p>
<!--hexo
---
url: changesets-in-monorepo
tags:
  - changesets
---
-->

<p><code>changesets</code>是目前(2023年)最流行的(多)包管理和发布工具了，使用它可以方便的生成CHANGELOG、打版本号和发布。</p>
<p>项目链接：<a target="_blank" rel="noopener" href="https://github.com/changesets/changesets">changesets</a></p>
<p>我这有个<a target="_blank" rel="noopener" href="https://github.com/taoliujun/npm-packages">pnpm monorepo</a>库，现在在用<code>changesets</code>管理发布版本了。</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm add -Dw @changesets/cli @changesets/changelog-git</span><br></pre></td></tr></table></figure>

<p><code>@changesets/cli</code>是必须安装的，<code>@changesets/changelog-git</code>是CHANGELOG生成风格，可以选择其他的，也可以不安装，用默认的。</p>
<h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm changeset init</span><br></pre></td></tr></table></figure>

<p>生成<code>.changeset</code>目录，里面有<code>config.json</code>，我修改了一下，如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;$schema&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://unpkg.com/@changesets/config@3.0.0/schema.json&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;changelog&quot;</span><span class="punctuation">:</span> <span class="string">&quot;@changesets/changelog-git&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="comment">// 在changeset add和changeset version后，自动运行git commit</span></span><br><span class="line">  <span class="attr">&quot;commit&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="comment">// 如果要发布到npm官方仓库，就设置成public</span></span><br><span class="line">  <span class="attr">&quot;access&quot;</span><span class="punctuation">:</span> <span class="string">&quot;public&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="comment">// 我的仓库的主分支是master</span></span><br><span class="line">  <span class="attr">&quot;baseBranch&quot;</span><span class="punctuation">:</span> <span class="string">&quot;master&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;fixed&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;linked&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;updateInternalDependencies&quot;</span><span class="punctuation">:</span> <span class="string">&quot;patch&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;ignore&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="发布一个包"><a href="#发布一个包" class="headerlink" title="发布一个包"></a>发布一个包</h2><p>现在，我要给包pack1添加一些新特性，和修复一些bug。</p>
<p>特性代码有点长，我要写好几天的代码。仍然按照以往的commit message的频率和风格去提交代码。这个commit message里的type和subject，<strong>都不会影响CHANGELOG和包版本号</strong>。</p>
<h3 id="随时添加一个changeset"><a href="#随时添加一个changeset" class="headerlink" title="随时添加一个changeset"></a>随时添加一个changeset</h3><p>当我完成一个特性，或修复了一个bug，可以随时打一个changeset标记，这样就可以记录下来，方便后面生成CHANGELOG。再次说明，这个changeset标记和commit message是互不冲突的，changeset标记是用来管理包版本的，而commit message是用来管理代码的。</p>
<p><em>这和之前使用lerna有点区别，lerna是根据commit message来决定版本号和CHANGLOG的，而<code>changesets</code>是根据<code>changeset add</code>和<code>changeset version</code>来决定的。</em></p>
<p><code>changeset</code>这么做的目的是，让开发者将包管理和代码管理分开，这样更加灵活。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 添加一个changeset标记</span><br><span class="line">pnpm changeset add</span><br></pre></td></tr></table></figure>

<p>会出现交互，让你选择要打标记的包，版本号等。</p>
<h4 id="选版本遇到一个坑，总是显示major？？？"><a href="#选版本遇到一个坑，总是显示major？？？" class="headerlink" title="选版本遇到一个坑，总是显示major？？？"></a>选版本遇到一个坑，总是显示<code>major</code>？？？</h4><p><code>changeset</code>老版本会让你上下选择版本类型，而新的<code>changeset</code>的交互改了，在提示<code>major</code>的时候，未选择的包，按回车后会进入到选择<code>minor</code>的步骤。</p>
<h3 id="生成CHANGELOG和版本号"><a href="#生成CHANGELOG和版本号" class="headerlink" title="生成CHANGELOG和版本号"></a>生成CHANGELOG和版本号</h3><p>终于，我完成了所有的特性和bug，准备发布了。</p>
<p>可以查看<code>.changeset</code>下有很多<code>.md</code>文件，这些就是之前随时添加的changeset标记。每一个文件描述了改动的包、改动的类型、改动的内容。在下一步操作之前，可以直接修改这些<code>.md</code>文件，来修改上述提到的类型、内容等。</p>
<p>准备好了，运行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm changeset version</span><br></pre></td></tr></table></figure>

<p>changeset会生成CHANGELOG和版本号，在最终发布之前，最好查看一下。</p>
<h3 id="发布"><a href="#发布" class="headerlink" title="发布"></a>发布</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm changeset publish</span><br></pre></td></tr></table></figure>

<p>它会自动调用<code>pnpm publish</code>，发布到npm仓库，并且打上tag。不过可惜的是，要手动push tag到远程：<code>git push --tags</code>。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://taoliujun.github.io/blog/changesets-in-monorepo/" data-id="clqxkljy20001jgq95scphg3x" data-title="在monorepo中使用changesets" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/changesets/" rel="tag">changesets</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-tsconfig-json" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/tsconfig-json/" class="article-date">
  <time class="dt-published" datetime="2023-09-04T18:51:45.000Z" itemprop="datePublished">2023-09-05</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/TypeScript/">TypeScript</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/tsconfig-json/">关于tsconfig.json，最后更新2023/11月...</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>原文链接：<a target="_blank" rel="noopener" href="https://github.com/taoliujun/blog/issues/23">https://github.com/taoliujun/blog/issues/23</a></p>
<!--hexo
---
url: tsconfig-json
tags:
  - typescript
---
-->

<p><strong>截至TypeScript 5.2</strong>，<code>tsconfig.json</code>的配置项已经有百十个之多，它的某些选项甚至影响了项目的执行结果，所以尽量多的了解它们能让程序员更深的了解ts，写出优美语句让CTO赞赏，甚至避免写出bug。</p>
<p>本issue的内容，只是个人在工作经验的影响下，对官方文档的内容理解。且内容有所欠缺，基本只记录了我工作涉及到的配置项，比如不怎么使用class，对class的配置项就略过了。</p>
<p>官方文档：<a target="_blank" rel="noopener" href="https://www.typescriptlang.org/tsconfig">https://www.typescriptlang.org/tsconfig</a></p>
<hr>
<!--hexo-->

<h1 id="Top-Level"><a href="#Top-Level" class="headerlink" title="Top Level"></a>Top Level</h1><p>一些根配置项。</p>
<h2 id="extends"><a href="#extends" class="headerlink" title="extends"></a>extends</h2><p>继承另一个配置文件，推荐的一些官方的配置文件来继承使用：<a target="_blank" rel="noopener" href="https://github.com/tsconfig/bases/tree/main/bases">https://github.com/tsconfig/bases/tree/main/bases</a></p>
<h2 id="files-include-exclude"><a href="#files-include-exclude" class="headerlink" title="files, include, exclude"></a>files, include, exclude</h2><p>这几项指定了在项目里，被ts作用的文件集合。配置本身没什么好说的，记录下它们之间的关系。</p>
<ul>
<li>如果files指定了，那么include的默认值是<code>[]</code>，否则include的默认值是<code>**/*</code>；</li>
<li>exclude用于排除include已指定的文件集合，但这些文件仍然是可以在项目里被引用的；</li>
<li>exclude默认排除了<code>node_modules</code>、<code>outDir</code>；</li>
</ul>
<h2 id="references"><a href="#references" class="headerlink" title="references"></a>references</h2><p>用于项目文件夹分别打包，并且其中有缓存机制的参与，所以编译速度会快很多。</p>
<p>如下项目结构：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./interface</span><br><span class="line">./components</span><br><span class="line">./user</span><br><span class="line">./admin</span><br><span class="line">./tsconfig.json</span><br></pre></td></tr></table></figure>

<p>在上面，user和admin文件夹分别是业务用户端、业务管理端，interface是接口定义，components是通用组件。在以往，改动了任何文件，都需要整个项目重新编译。而在使用references之后，将4个文件夹中放入对应的tsconfig.json并各有配置，在根tsconfig中指定好references的path后，tsc利用缓存机制，会只打包改动过的文件夹。</p>
<!--hexo-->

<h1 id="compilerOptions"><a href="#compilerOptions" class="headerlink" title="compilerOptions"></a>compilerOptions</h1><p>编译器配置项太多了，按作用拆分成几个评论来说。</p>
<!--hexo-->

<h1 id="compilerOptions-Type-Checking"><a href="#compilerOptions-Type-Checking" class="headerlink" title="compilerOptions - Type Checking"></a>compilerOptions - Type Checking</h1><p>和类型检查有关的配置项。</p>
<h2 id="strict"><a href="#strict" class="headerlink" title="strict"></a>strict</h2><p>strict是一个严格模式的快捷开关，开启后会默认打开strictNullChecks、noImplicitAny等选项。并且随着typescript的升级，它可能会默认开启新增特性，列出截至5.2默认开启的选项：</p>
<p><a target="_blank" rel="noopener" href="https://www.typescriptlang.org/tsconfig#alwaysStrict">alwaysStrict</a><br><a target="_blank" rel="noopener" href="https://www.typescriptlang.org/tsconfig#strictNullChecks">strictNullChecks</a><br><a target="_blank" rel="noopener" href="https://www.typescriptlang.org/tsconfig#strictBindCallApply">strictBindCallApply</a><br><a target="_blank" rel="noopener" href="https://www.typescriptlang.org/tsconfig#strictFunctionTypes">strictFunctionTypes</a><br><a target="_blank" rel="noopener" href="https://www.typescriptlang.org/tsconfig#strictPropertyInitialization">strictPropertyInitialization</a><br><a target="_blank" rel="noopener" href="https://www.typescriptlang.org/tsconfig#noImplicitAny">noImplicitAny</a><br><a target="_blank" rel="noopener" href="https://www.typescriptlang.org/tsconfig#noImplicitThis">noImplicitThis</a><br><a target="_blank" rel="noopener" href="https://www.typescriptlang.org/tsconfig#useUnknownInCatchVariables">useUnknownInCatchVariables</a></p>
<h2 id="alwaysStrict"><a href="#alwaysStrict" class="headerlink" title="alwaysStrict"></a>alwaysStrict</h2><p>对所有文件启用javascript strict模式。注意，这和typescript strict不是同一个东西。参考：<a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Strict_mode">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Strict_mode</a></p>
<h2 id="allowUnreachableCode"><a href="#allowUnreachableCode" class="headerlink" title="allowUnreachableCode"></a>allowUnreachableCode</h2><p>对未使用的代码的处理策略，可设置警告(默认)、错误、忽略。</p>
<h2 id="allowUnusedLabels"><a href="#allowUnusedLabels" class="headerlink" title="allowUnusedLabels"></a>allowUnusedLabels</h2><p>对未使用的Label的处理策略，可设置警告(默认)、错误、忽略。</p>
<h2 id="exactOptionalPropertyTypes"><a href="#exactOptionalPropertyTypes" class="headerlink" title="exactOptionalPropertyTypes"></a>exactOptionalPropertyTypes</h2><p>对可选项设置为undefined的策略。</p>
<p>举例：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    sex?: <span class="number">1</span> | <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="attr">man</span>: <span class="title class_">User</span> = &#123;&#125;;</span><br><span class="line">man.<span class="property">sex</span> = <span class="number">1</span>;</span><br><span class="line">man.<span class="property">sex</span> = <span class="number">0</span>;</span><br><span class="line">man.<span class="property">sex</span> = <span class="literal">undefined</span>;</span><br></pre></td></tr></table></figure>

<p><code>User.sex</code>是一个可选项，它的预期值是<code>0|1|undefined</code>。但是呢，<code>sex</code>可选想表达的意思是未被定义，而不是值真的是undefined。那么开启本选项后，<code>man.sex = undefined</code>这个赋值语句会给一个报错。</p>
<h2 id="noImplicitAny"><a href="#noImplicitAny" class="headerlink" title="noImplicitAny"></a>noImplicitAny</h2><p>对推导类型为any的策略。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">fn</span>(<span class="params">s</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(s.<span class="title function_">subtr</span>(<span class="number">3</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>入参<code>s</code>推导为<code>any</code>，在选项开启情况下会报错。</p>
<h2 id="noImplicitReturns"><a href="#noImplicitReturns" class="headerlink" title="noImplicitReturns"></a>noImplicitReturns</h2><p>对函数每个分支必须有return语句的策略。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">fn</span>(<span class="params">s: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (s) &#123;</span><br><span class="line">        <span class="keyword">return</span> s.<span class="title function_">substring</span>(<span class="number">3</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="string">&#x27;nothing&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>开启后，ts报错认为<code>fn</code>函数的最后没有return语句。</p>
<h2 id="noPropertyAccessFromIndexSignature"><a href="#noPropertyAccessFromIndexSignature" class="headerlink" title="noPropertyAccessFromIndexSignature"></a>noPropertyAccessFromIndexSignature</h2><p>对访问未定义的对象属性的策略。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    name?: <span class="built_in">string</span>;</span><br><span class="line">    [<span class="attr">key</span>: <span class="built_in">string</span>]: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> <span class="attr">a</span>: <span class="title class_">User</span> = &#123;&#125;;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a.<span class="property">name</span>, a[<span class="string">&#x27;name&#x27;</span>], a.<span class="property">sex</span>, a[<span class="string">&#x27;sex&#x27;</span>]);</span><br></pre></td></tr></table></figure>

<p>访问对象属性有<code>.</code>和<code>[index]</code>两个方式，访问未定义的属性，开启本选项后，在<code>a.sex</code>处会抛出一个错误。</p>
<h2 id="noUncheckedIndexedAccess"><a href="#noUncheckedIndexedAccess" class="headerlink" title="noUncheckedIndexedAccess"></a>noUncheckedIndexedAccess</h2><p>未定义的对象属性值类型，给追加上<code>undefined</code>类型。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="built_in">string</span>;</span><br><span class="line">    [<span class="attr">propName</span>: <span class="built_in">string</span>]: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> <span class="keyword">const</span> <span class="attr">admin</span>: <span class="title class_">User</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// (property) User.name: string</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(admin.<span class="property">name</span>);</span><br><span class="line"><span class="comment">// (index) User[string]: string</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(admin.<span class="property">birthday</span>);</span><br></pre></td></tr></table></figure>

<p>上例中，birthday的值类型是<code>string</code>，开启本项后，类型追加上<code>undefined</code>。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// (index) User[string]: string | undefined</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(admin.<span class="property">birthday</span>);</span><br></pre></td></tr></table></figure>

<h2 id="noUnusedLocals"><a href="#noUnusedLocals" class="headerlink" title="noUnusedLocals"></a>noUnusedLocals</h2><p>局部变量未使用，抛出错误。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">test</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> defaultModelID = <span class="number">23</span>;</span><br><span class="line"><span class="comment">// &#x27;defaultModelID&#x27; is declared but its value is never read.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="noUnusedParameters"><a href="#noUnusedParameters" class="headerlink" title="noUnusedParameters"></a>noUnusedParameters</h2><p>入参未使用，抛出错误。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">createDefaultKeyboard</span> = (<span class="params">modelID: <span class="built_in">number</span></span>) =&gt; &#123;</span><br><span class="line"><span class="comment">// &#x27;modelID&#x27; is declared but its value is never read.</span></span><br><span class="line">  <span class="keyword">const</span> defaultModelID = <span class="number">23</span>;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">type</span>: <span class="string">&quot;keyboard&quot;</span>, <span class="attr">modelID</span>: defaultModelID &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="strictBindCallApply"><a href="#strictBindCallApply" class="headerlink" title="strictBindCallApply"></a>strictBindCallApply</h2><p>在使用函数的call、bind、apply时，是否要检查传入参数的类型。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">fn</span>(<span class="params">x: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> n1 = fn.<span class="title function_">call</span>(<span class="literal">undefined</span>, <span class="string">&#x27;10&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> n2 = fn.<span class="title function_">call</span>(<span class="literal">undefined</span>, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure>

<p>如上代码中，第二个call中的入参false和string类型不匹配而报错。</p>
<h2 id="strictFunctionTypes"><a href="#strictFunctionTypes" class="headerlink" title="strictFunctionTypes"></a>strictFunctionTypes</h2><p>更精确的检查函数入参类型。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">GetUser</span> = <span class="function">(<span class="params">id: <span class="built_in">string</span> | <span class="built_in">number</span></span>) =&gt;</span> <span class="built_in">any</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">test</span>(<span class="params">x: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> <span class="attr">getUser</span>: <span class="title class_">GetUser</span> = test;</span><br></pre></td></tr></table></figure>

<p>如上代码中，GetUser的入参类型<code>string | number</code>不能精确的分配给test的入参类型<code>string</code>。</p>
<h2 id="strictNullChecks"><a href="#strictNullChecks" class="headerlink" title="strictNullChecks"></a>strictNullChecks</h2><p>是否校验<code>null</code>, <code>undefined</code>的属性访问？</p>
<p>在以往的纯js项目中，容易忽略变量为undefined后仍然访问其属性的场景，比如在如下代码中，忽略了<code>a</code>为<code>undefined</code>的情况，导致运行时引发异常。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a = arr1.<span class="title function_">find</span>();</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a.<span class="property">name</span>)</span><br></pre></td></tr></table></figure>

<p>本选项开启后，在静态检查时就提示开发者，变量可能是<code>null</code>, <code>undefined</code>，不能访问到<code>name</code>属性。</p>
<h2 id="useUnknownInCatchVariables"><a href="#useUnknownInCatchVariables" class="headerlink" title="useUnknownInCatchVariables"></a>useUnknownInCatchVariables</h2><p>有时候我们并不知道catch的err类型是什么，它的类型由try里的实际运行分支决定，而如果当成any处理，那么访问它的属性是危险的。当开启本项后，err的类型是unknown，必须先限定其类型再安全的访问其属性，如：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">  <span class="keyword">if</span> (err <span class="keyword">instanceof</span> <span class="title class_">Error</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(err.<span class="property">message</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<!--hexo-->

<h1 id="compilerOptions-Modules"><a href="#compilerOptions-Modules" class="headerlink" title="compilerOptions - Modules"></a>compilerOptions - Modules</h1><p>模块的处理策略。</p>
<h2 id="allowArbitraryExtensions"><a href="#allowArbitraryExtensions" class="headerlink" title="allowArbitraryExtensions"></a>allowArbitraryExtensions</h2><p>ts默认支持了ts、js、cjs、jsx等模块的解析描述，通过<code>global.d.ts</code>的定义扩展，还可以支持css、jpg等模块的解析描述（你要自己保证webpack loader之类的解析器去真实支持加载这些模块）。而有时候，需要对特定模块文件（不管是否已全局定义过该模块的描述）做特别的描述，就可以开启该选项，并且创建一个<code>&#123;file basename&#125;.d.&#123;extension&#125;.ts</code>文件。</p>
<p>如：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test.ts</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 报错：Cannot find module &#x27;./a.jpk&#x27; or its corresponding type declarations.ts(2307)</span></span><br><span class="line"><span class="keyword">import</span> a <span class="keyword">from</span> <span class="string">&#x27;./a.jpk&#x27;</span>;</span><br><span class="line"><span class="comment">// doTest类型是any</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a.<span class="title function_">doTest</span>());</span><br></pre></td></tr></table></figure>

<p>开启该项，并增加<code>a.d.jpk.ts</code>文件：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// a.d.jpk.ts</span></span><br><span class="line"><span class="keyword">declare</span> <span class="keyword">const</span> <span class="attr">jpk</span>: &#123;</span><br><span class="line">    <span class="attr">doTest</span>: <span class="function">() =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> jpk;</span><br><span class="line"></span><br><span class="line"><span class="comment">// test.ts</span></span><br><span class="line"><span class="keyword">import</span> a <span class="keyword">from</span> <span class="string">&#x27;./a.jpk&#x27;</span>;</span><br><span class="line"><span class="comment">// doTest的类型：(property) doTest: () =&gt; void</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a.<span class="title function_">doTest</span>());</span><br></pre></td></tr></table></figure>

<h2 id="allowImportingTsExtensions"><a href="#allowImportingTsExtensions" class="headerlink" title="allowImportingTsExtensions"></a>allowImportingTsExtensions</h2><p>是否允许在import path带入ts、tsx等后缀名。</p>
<p>ts项目需要编译成js代码后执行，如果我们使用ts-node来执行项目，可以启用<code>noEmit</code>来禁止这个编译行为，并且在项目源码中直接引入<code>.ts</code>来引入正确的、完整的路径。</p>
<p>举例：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; wait &#125; <span class="keyword">from</span> <span class="string">&#x27;@/utils/utils.ts&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="allowUmdGlobalAccess"><a href="#allowUmdGlobalAccess" class="headerlink" title="allowUmdGlobalAccess"></a>allowUmdGlobalAccess</h2><p>&#x2F;&#x2F; TODO<br>和umd的声明有关系，不过我还不明确它的意义。见：<a target="_blank" rel="noopener" href="https://github.com/microsoft/TypeScript/pull/30776%E3%80%82">https://github.com/microsoft/TypeScript/pull/30776。</a></p>
<h2 id="baseUrl"><a href="#baseUrl" class="headerlink" title="baseUrl"></a>baseUrl</h2><p>为解析无路径修饰的模块，设置一个基础路径。 什么叫做无路径修饰？就是该模块不是一个绝对或相对路径，如<code>import a from &#39;@/hello/world&#39;</code>。</p>
<p>如果配置了该项，那么ts从该项指定的目录中开始查找模块，优先级也高于<code>node_modules</code>。</p>
<h2 id="module"><a href="#module" class="headerlink" title="module"></a>module</h2><p>模块打包的策略，也就是指编译后的模块加载代码是require、import之类的语法。推荐大家阅读：<a target="_blank" rel="noopener" href="https://www.typescriptlang.org/docs/handbook/modules/theory.html">模块理论</a>。</p>
<p>这个话题有点繁琐，也涉及到javascript的模块化amd、umd之类的历史，对于2023年这个时间点来说，关注下CommonJS、ESM即可，ESM还细分为ES2015、ES20XX等版本，他们的模块打包策略是一样的，区别是更高版本的ESM还支持了<code>dynamic imports</code>、<code>import.meta</code>和<code>top level await</code>之类的东西。</p>
<p>补充的是，nodejs的模块打包策略也早就支持esm了，具体参照package.json的设置：<a target="_blank" rel="noopener" href="https://www.typescriptlang.org/docs/handbook/modules/reference.html#node16-nodenext">https://www.typescriptlang.org/docs/handbook/modules/reference.html#node16-nodenext</a></p>
<h2 id="moduleResolution"><a href="#moduleResolution" class="headerlink" title="moduleResolution"></a>moduleResolution</h2><p>加载模块的策略，也就是指用什么策略去解析<code>import xxx from &#39;pathA&#39;</code>这里的<code>pathA</code>。<strong>注意区分和module的关系，module指的是项目的模块化是如何打包的，而moduleResolution指的是项目如何加载模块的</strong>。截至2023支持如下策略：</p>
<ul>
<li>node16&#x2F;nodenext，对于Node12+版本，本策略可自由根据import&#x2F;require选择合适的算法去加载模块。</li>
<li>node10，对于Node12之前的版本，本策略只支持require算法加载模块。<strong>基本不用关心了</strong></li>
<li>bundler，和node16一样，但不要求模块有后缀名。</li>
<li>classic，早期的策略，不用管了。</li>
</ul>
<p><strong>这东西还要和module搭配使用，并且！并且！和package.json还有扯不清的关系。强烈建议阅读上文提到的<a target="_blank" rel="noopener" href="https://www.typescriptlang.org/docs/handbook/modules/theory.html">模块理论</a></strong></p>
<p>另外，由于自己对这块的理解也不足深，还参考了这篇文章：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/621795173%E3%80%82">https://zhuanlan.zhihu.com/p/621795173。</a></p>
<h2 id="moduleSuffixes"><a href="#moduleSuffixes" class="headerlink" title="moduleSuffixes"></a>moduleSuffixes</h2><p>模块搜索时的文件扩展名补充，比如以下配置项：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;compilerOptions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;moduleSuffixes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;.ios&quot;</span><span class="punctuation">,</span> <span class="string">&quot;.native&quot;</span><span class="punctuation">,</span> <span class="string">&quot;&quot;</span><span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> foo <span class="keyword">from</span> <span class="string">&quot;./foo&quot;</span>;</span><br></pre></td></tr></table></figure>
<p>TypeScript 会按顺序寻找<code>./foo.ios.ts</code>、<code>./foo.native.ts</code>、<code>./foo.ts</code>。</p>
<h2 id="paths"><a href="#paths" class="headerlink" title="paths"></a>paths</h2><p>在加载模块路径时，加入一个别名匹配。可以理解为webpack的alias。</p>
<h2 id="resolveJsonModule"><a href="#resolveJsonModule" class="headerlink" title="resolveJsonModule"></a>resolveJsonModule</h2><p>允许加载json模块（文件）。</p>
<h2 id="resolvePackageJsonExports"><a href="#resolvePackageJsonExports" class="headerlink" title="resolvePackageJsonExports"></a>resolvePackageJsonExports</h2><p>引用<code>node_modules</code>包时，强制遵循包package.json的exports字段的定义。还是那句话，阅读下模块理论那篇文章，不然很难理解前面这句话的信息量。</p>
<h2 id="resolvePackageJsonImports"><a href="#resolvePackageJsonImports" class="headerlink" title="resolvePackageJsonImports"></a>resolvePackageJsonImports</h2><p>强制typescript使用package.json中imports字段的定义去加载<code>#</code>符号开头的模块路径。例：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// package.json</span></span><br><span class="line"><span class="string">&quot;imports&quot;</span>: &#123;</span><br><span class="line">   <span class="string">&quot;#test/*&quot;</span>: <span class="string">&quot;./src/test/*&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/test/1.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> a = <span class="number">123</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/b.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; a &#125; <span class="keyword">from</span> <span class="string">&#x27;#test/1&#x27;</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;==a&#x27;</span>, a);</span><br></pre></td></tr></table></figure>

<h2 id="rootDir"><a href="#rootDir" class="headerlink" title="rootDir"></a>rootDir</h2><p>指定项目的根目录，默认值可以理解为所有ts文件目录的最大集。例如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MyProj</span><br><span class="line">├── tsconfig.json</span><br><span class="line">├── core</span><br><span class="line">│   ├── a.ts</span><br><span class="line">│   ├── b.ts</span><br><span class="line">│   ├── sub</span><br><span class="line">│   │   ├── c.ts</span><br><span class="line">├── types.d.ts</span><br></pre></td></tr></table></figure>

<p>如上的项目，rootDir的推断值是”core”。但是你可以手工指定为<code>tsconfig.json</code>的相对目录”，比如.”。</p>
<p>另外，如果设置了<code>composite</code>，<code>rootDir</code>的默认值就是<code>tsconfig.json</code>文件的目录。</p>
<h2 id="rootDirs"><a href="#rootDirs" class="headerlink" title="rootDirs"></a>rootDirs</h2><p>这个属性有点拽，它可以将多个目录虚拟成一个目录。这样在<code>import</code>的时候，就当成同一个目录就行啦。</p>
<h2 id="typeRoots"><a href="#typeRoots" class="headerlink" title="typeRoots"></a>typeRoots</h2><p>类型定义文件的目录，默认所有@types目录都会被包含，包括node_modules下的@types目录。<br>如果指定了typeRoots，那么@types目录的相关规则会被忽略。</p>
<h2 id="types"><a href="#types" class="headerlink" title="types"></a>types</h2><p>类型定义文件的具体目录，规则和<code>typeRoots</code>一样，不同点是<code>types</code>只指定具体目录，而非<code>*</code>这种匹配型目录。</p>
<!--hexo-->

<h1 id="compilerOptions-Emit"><a href="#compilerOptions-Emit" class="headerlink" title="compilerOptions - Emit"></a>compilerOptions - Emit</h1><p>编译策略。</p>
<h2 id="outDir"><a href="#outDir" class="headerlink" title="outDir"></a>outDir</h2><p>编译文件放置的目录，默认和源码放同一个目录。</p>
<h2 id="noEmit"><a href="#noEmit" class="headerlink" title="noEmit"></a>noEmit</h2><p>不要编译ts。</p>
<p>项目中一般使用babel去编译，typescript仅用来做静态检查，所以设置noEmit就可以不生成js、sourcemap、declaration文件了。</p>
<h2 id="noEmitOnError"><a href="#noEmitOnError" class="headerlink" title="noEmitOnError"></a>noEmitOnError</h2><p>顾名思义，在检查到错误的时候，不要继续编译了。</p>
<h2 id="declaration-x2F-emitDeclarationOnly-x2F-declarationDir"><a href="#declaration-x2F-emitDeclarationOnly-x2F-declarationDir" class="headerlink" title="declaration &#x2F; emitDeclarationOnly &#x2F; declarationDir"></a>declaration &#x2F; emitDeclarationOnly &#x2F; declarationDir</h2><p>生成类型描述文件。</p>
<p>这个是typescript最重要的几个特性之一了，为<code>.ts</code>文件生成类型定义文件<code>.d.ts</code>。如果不想同时生成<code>.js</code>文件，则使用<code>emitDeclarationOnly</code>。</p>
<p>同时，可以使用<code>declarationDir</code>指定类型定义文件的生成目录。</p>
<h2 id="declarationMap"><a href="#declarationMap" class="headerlink" title="declarationMap"></a>declarationMap</h2><p>给<code>.d.ts</code>文件增加一个map标识到<code>.ts</code>源文件，类似sourceMap。</p>
<h2 id="sourceMap-x2F-inlineSourceMap-x2F-inlineSources-x2F-mapRoot-x2F-sourceRoot"><a href="#sourceMap-x2F-inlineSourceMap-x2F-inlineSources-x2F-mapRoot-x2F-sourceRoot" class="headerlink" title="sourceMap &#x2F; inlineSourceMap &#x2F; inlineSources &#x2F; mapRoot &#x2F; sourceRoot"></a>sourceMap &#x2F; inlineSourceMap &#x2F; inlineSources &#x2F; mapRoot &#x2F; sourceRoot</h2><p>typescript也是支持souce map的，这里就不解释sourcemap是什么了。它的相关配置项有：</p>
<p>sourceMap，生成sourcemap文件。<br>inlineSourceMap，不生成sourcemap文件，而是直接把source内容写在.js文件中。<br>inlineSources，同inlineSourceMap。<br>mapRoot，指定sourceMap文件的路径，比如部署到网络中，可以指定为”<a target="_blank" rel="noopener" href="http://xxxx.com"./">http://xxxx.com"。</a><br>sourceRoot，指定source文件的路径，同mapRoot。</p>
<h2 id="downlevelIteration"><a href="#downlevelIteration" class="headerlink" title="downlevelIteration"></a>downlevelIteration</h2><p>对迭代器的降级解析。</p>
<p>在es6中增加了for&#x2F;of，spread等迭代特性，typescript在编译成es5的时候，要使用何种语法。文档中有个字符遍历的例子说明开启与否的迭代影响，这对业务计算结果是有影响的。</p>
<p>不过项目中使用了babel之类的编译器，就不用担心这些影响了。</p>
<h2 id="importHelpers"><a href="#importHelpers" class="headerlink" title="importHelpers"></a>importHelpers</h2><p>引入降级解析的包。</p>
<p>将es6的某些特新编译成es5，如迭代器、异步语法等，会将模块中每个相应的代码都编译成降级代码，使得类似代码重复。如：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> __read = (<span class="variable language_">this</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">__read</span>) || <span class="keyword">function</span> (<span class="params">o, n</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> m = <span class="keyword">typeof</span> <span class="title class_">Symbol</span> === <span class="string">&quot;function&quot;</span> &amp;&amp; o[<span class="title class_">Symbol</span>.<span class="property">iterator</span>];</span><br><span class="line">    <span class="keyword">if</span> (!m) <span class="keyword">return</span> o;</span><br><span class="line">    <span class="keyword">var</span> i = m.<span class="title function_">call</span>(o), r, ar = [], e;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> ((n === <span class="built_in">void</span> <span class="number">0</span> || n-- &gt; <span class="number">0</span>) &amp;&amp; !(r = i.<span class="title function_">next</span>()).<span class="property">done</span>) ar.<span class="title function_">push</span>(r.<span class="property">value</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (error) &#123; e = &#123; <span class="attr">error</span>: error &#125;; &#125;</span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (r &amp;&amp; !r.<span class="property">done</span> &amp;&amp; (m = i[<span class="string">&quot;return&quot;</span>])) m.<span class="title function_">call</span>(i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span> &#123; <span class="keyword">if</span> (e) <span class="keyword">throw</span> e.<span class="property">error</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ar;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> __spreadArray = (<span class="variable language_">this</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">__spreadArray</span>) || <span class="keyword">function</span> (<span class="params">to, <span class="keyword">from</span>, pack</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (pack || <span class="variable language_">arguments</span>.<span class="property">length</span> === <span class="number">2</span>) <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, l = <span class="keyword">from</span>.<span class="property">length</span>, ar; i &lt; l; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ar || !(i <span class="keyword">in</span> <span class="keyword">from</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!ar) ar = <span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">slice</span>.<span class="title function_">call</span>(<span class="keyword">from</span>, <span class="number">0</span>, i);</span><br><span class="line">            ar[i] = <span class="keyword">from</span>[i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> to.<span class="title function_">concat</span>(ar || <span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">slice</span>.<span class="title function_">call</span>(<span class="keyword">from</span>));</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">fn</span>(<span class="params">arr</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> arr2 = <span class="title function_">__spreadArray</span>([<span class="number">1</span>], <span class="title function_">__read</span>(arr), <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果同时开启了<code>downlevelIteration</code>和<code>importHelpers</code>，并且安装了<code>tslib</code>包，那么代码会编译成类似这样：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; __read, __spreadArray &#125; <span class="keyword">from</span> <span class="string">&quot;tslib&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">fn</span>(<span class="params">arr</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> arr2 = <span class="title function_">__spreadArray</span>([<span class="number">1</span>], <span class="title function_">__read</span>(arr), <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="noEmitHelpers"><a href="#noEmitHelpers" class="headerlink" title="noEmitHelpers"></a>noEmitHelpers</h2><p>typescript处理迭代器、异步等的降级策略是生成一堆降级代码，也可以使用”importHelpers”和”tslib”来提取公共代码。但通过这个配置，可以自定义降级代码了。具体参照文档。</p>
<h2 id="preserveConstEnums"><a href="#preserveConstEnums" class="headerlink" title="preserveConstEnums"></a>preserveConstEnums</h2><p>是否在编辑结果中移除<code>const enum</code>的定义。因为javascript没有enum概念，typescript会将enum的引用编译成具体的值。如：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">enum</span> <span class="title class_">Album</span> &#123;</span><br><span class="line">  <span class="title class_">JimmyEatWorldFutures</span> = <span class="number">1</span>,</span><br><span class="line">  <span class="title class_">TubRingZooHypothesis</span> = <span class="number">2</span>,</span><br><span class="line">  <span class="title class_">DogFashionDiscoAdultery</span> = <span class="number">3</span>,</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">const</span> selectedAlbum = <span class="title class_">Album</span>.<span class="property">JimmyEatWorldFutures</span>;</span><br><span class="line"><span class="keyword">if</span> (selectedAlbum === <span class="title class_">Album</span>.<span class="property">JimmyEatWorldFutures</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;That is a great choice.&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译结果如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> selectedAlbum = <span class="number">1</span> <span class="comment">/* Album.JimmyEatWorldFutures */</span>;</span><br><span class="line"><span class="keyword">if</span> (selectedAlbum === <span class="number">1</span> <span class="comment">/* Album.JimmyEatWorldFutures */</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;That is a great choice.&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果开启此项，则编译结果中会描述出该enum的结构。如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> <span class="title class_">Album</span>;</span><br><span class="line">(<span class="keyword">function</span> (<span class="params">Album</span>) &#123;</span><br><span class="line">    <span class="title class_">Album</span>[<span class="title class_">Album</span>[<span class="string">&quot;JimmyEatWorldFutures&quot;</span>] = <span class="number">1</span>] = <span class="string">&quot;JimmyEatWorldFutures&quot;</span>;</span><br><span class="line">    <span class="title class_">Album</span>[<span class="title class_">Album</span>[<span class="string">&quot;TubRingZooHypothesis&quot;</span>] = <span class="number">2</span>] = <span class="string">&quot;TubRingZooHypothesis&quot;</span>;</span><br><span class="line">    <span class="title class_">Album</span>[<span class="title class_">Album</span>[<span class="string">&quot;DogFashionDiscoAdultery&quot;</span>] = <span class="number">3</span>] = <span class="string">&quot;DogFashionDiscoAdultery&quot;</span>;</span><br><span class="line">&#125;)(<span class="title class_">Album</span> || (<span class="title class_">Album</span> = &#123;&#125;));</span><br><span class="line"><span class="keyword">const</span> selectedAlbum = <span class="number">1</span> <span class="comment">/* Album.JimmyEatWorldFutures */</span>;</span><br><span class="line"><span class="keyword">if</span> (selectedAlbum === <span class="number">1</span> <span class="comment">/* Album.JimmyEatWorldFutures */</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;That is a great choice.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="preserveValueImports"><a href="#preserveValueImports" class="headerlink" title="preserveValueImports"></a>preserveValueImports</h2><p>通常，打包器会将未使用的”import”移除掉，但开启了该特性后，会在编译中保留未使用的”import”。例如：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Animal</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./animal.js&quot;</span>;</span><br><span class="line"><span class="built_in">eval</span>(<span class="string">&quot;console.log(new Animal().isDangerous())&quot;</span>);</span><br></pre></td></tr></table></figure>

<h2 id="removeComments"><a href="#removeComments" class="headerlink" title="removeComments"></a>removeComments</h2><p>移除代码中的注释。</p>
<!--hexo-->

<h1 id="compilerOptions-JavaScript-Support"><a href="#compilerOptions-JavaScript-Support" class="headerlink" title="compilerOptions - JavaScript Support"></a>compilerOptions - JavaScript Support</h1><p>对javascript文件的支持</p>
<h2 id="allowJs"><a href="#allowJs" class="headerlink" title="allowJs"></a>allowJs</h2><p>允许<code>.ts</code>文件引用<code>.js</code>文件，这常用在javascript项目升级为typescript的过程中。</p>
<h2 id="checkJs"><a href="#checkJs" class="headerlink" title="checkJs"></a>checkJs</h2><p>是否开启对<code>.js</code>文件的错误检查。</p>
<h2 id="maxNodeModuleJsDepth"><a href="#maxNodeModuleJsDepth" class="headerlink" title="maxNodeModuleJsDepth"></a>maxNodeModuleJsDepth</h2><p>为<code>.js</code>文件寻找类型定义文件时，允许的最大依赖深度。</p>
<p>正常情况下，我们会在<code>.js</code>文件的同级补写<code>.d.ts</code>文件，tsc会很快找到类型定义。但有时候确实要扩大搜索范围去找部分<code>.js</code>文件的类型定义文件。</p>
<!--hexo-->

<h1 id="compilerOptions-Interop-Constraints"><a href="#compilerOptions-Interop-Constraints" class="headerlink" title="compilerOptions - Interop Constraints"></a>compilerOptions - Interop Constraints</h1><p>(模块)互相操作的约束</p>
<h2 id="allowSyntheticDefaultImports"><a href="#allowSyntheticDefaultImports" class="headerlink" title="allowSyntheticDefaultImports"></a>allowSyntheticDefaultImports</h2><p>允许合成<code>default</code>。</p>
<p>如果一个模块A没有<code>export default</code>，那么另一个模块B在<code>import defaultA from &#39;./a&#39;</code>的时候，会抛出错误说A中没有default。</p>
<p>有一个做法是<code>import * as defaultA from &#39;./a&#39;</code>曲线救国，但开启这个配置项后，可以直接使用<code>import defaultA from &#39;./a&#39;</code>这样的语法了。</p>
<h2 id="esModuleInterop"><a href="#esModuleInterop" class="headerlink" title="esModuleInterop"></a>esModuleInterop</h2><p>esm在使用<code>import default from &#39;xxx&#39;</code>方式导入cjs的时候会抛出一个错误，因为cjs模块中没有default。开启此选项后，typescript会使用一些helpers去兼容cjs的default问题。</p>
<h2 id="forceConsistentCasingInFileNames"><a href="#forceConsistentCasingInFileNames" class="headerlink" title="forceConsistentCasingInFileNames"></a>forceConsistentCasingInFileNames</h2><p>强制引用的模块文件名，和磁盘中的文件名保持一致的大小写。</p>
<!--hexo-->

<h1 id="compilerOptions-Language-and-Environment"><a href="#compilerOptions-Language-and-Environment" class="headerlink" title="compilerOptions - Language and Environment"></a>compilerOptions - Language and Environment</h1><p>和语言、环境有关的配置项。</p>
<h2 id="jsx"><a href="#jsx" class="headerlink" title="jsx"></a>jsx</h2><p>如何解析<code>.tsx</code>文件中jsx语法？在2023年，react17+后，用<code>react-jsx</code>就行了。</p>
<h2 id="lib"><a href="#lib" class="headerlink" title="lib"></a>lib</h2><p>在项目中使用的api类型定义集合。</p>
<p>ts是需要知道你用的每一个javascript方法、属性的定义的，所以它内置了一批定义（比如Math.abs方法）。但是呢，后面新增方法的定义，需要你手工指定包含，ts才能理解了，比如Array.include方法，你就要包含ES2016。但好在你不需要记住这些，因为当你指定<code>target</code>字段时，lib会被默认设置成对应的值的。</p>
<p>另外，大部分情况下，我们要访问一些和特定环境有关的特性，比如浏览器里的Dom特性，那么这儿额外引入<code>DOM</code>定义就行了。</p>
<h2 id="target"><a href="#target" class="headerlink" title="target"></a>target</h2><p>项目编译的目标javascript版本。</p>
<p>也就是你的目标客户端支持的最低javascript版本。注意它会影响默认的<code>lib</code>配置项。</p>
<!--hexo-->

<h1 id="compilerOptions-Compiler-Diagnostics"><a href="#compilerOptions-Compiler-Diagnostics" class="headerlink" title="compilerOptions - Compiler Diagnostics"></a>compilerOptions - Compiler Diagnostics</h1><p>编译诊断配置项。</p>
<h2 id="diagnostics-x2F-extendedDiagnostics"><a href="#diagnostics-x2F-extendedDiagnostics" class="headerlink" title="diagnostics &#x2F; extendedDiagnostics"></a>diagnostics &#x2F; extendedDiagnostics</h2><p>打印出编译的信息，比如多少文件、编译时间等。</p>
<p>extendedDiagnostics包含了diagnostics给出的所有信息，所以用extendedDiagnostics就行了。这是一个开启extendedDiagnostics的编译信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Files:                         143</span><br><span class="line">Lines of Library:            38663</span><br><span class="line">Lines of Definitions:        82578</span><br><span class="line">Symbols:                     73362</span><br><span class="line">Types:                        1495</span><br><span class="line">Parse time:                  0.50s</span><br><span class="line">ResolveModule time:          0.03s</span><br><span class="line">Total time:                  1.01s</span><br></pre></td></tr></table></figure>

<h2 id="explainFiles"><a href="#explainFiles" class="headerlink" title="explainFiles"></a>explainFiles</h2><p>打印出文件被编译的原因，也就是它们的引用链。</p>
<h2 id="listEmittedFiles-x2F-listFiles"><a href="#listEmittedFiles-x2F-listFiles" class="headerlink" title="listEmittedFiles &#x2F; listFiles"></a>listEmittedFiles &#x2F; listFiles</h2><p>列出参与编译的文件。</p>
<h2 id="traceResolution"><a href="#traceResolution" class="headerlink" title="traceResolution"></a>traceResolution</h2><p>打印每一个文件的编译流程。</p>
<!--hexo-->

<h1 id="compilerOptions-Completeness"><a href="#compilerOptions-Completeness" class="headerlink" title="compilerOptions - Completeness"></a>compilerOptions - Completeness</h1><p>完整性检测的配置项</p>
<h2 id="skipLibCheck"><a href="#skipLibCheck" class="headerlink" title="skipLibCheck"></a>skipLibCheck</h2><p>跳过lib库的类型检测。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://taoliujun.github.io/blog/tsconfig-json/" data-id="clqxkljy50003jgq99l4of3q1" data-title="关于tsconfig.json，最后更新2023/11月..." class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/typescript/" rel="tag">typescript</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-typescript-means" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/typescript-means/" class="article-date">
  <time class="dt-published" datetime="2023-08-02T17:52:04.000Z" itemprop="datePublished">2023-08-03</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/TypeScript/">TypeScript</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/typescript-means/">TypeScript的小手段，最后更新2023/12月...</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>原文链接：<a target="_blank" rel="noopener" href="https://github.com/taoliujun/blog/issues/22">https://github.com/taoliujun/blog/issues/22</a></p>
<!--hexo
---
url: typescript-means
tags:
  - typescript
---
-->

<p>TypeScript有一些小手段，评论区见。</p>
<ul>
<li><a href="#issuecomment-1663199481">as断言的另外写法</a></li>
<li><a href="#issuecomment-1663206615">as const</a></li>
<li><a href="#issuecomment-1663206898">非null | undefined声明</a></li>
<li><a href="#issuecomment-1838108783">const enum</a></li>
<li><a href="#issuecomment-1841954904">@ts-expect-error</a></li>
<li><a href="#issuecomment-1842016788">解构变量可标记为“不使用”</a></li>
</ul>
<!--hexo-->

<h1 id="as断言的另外写法"><a href="#as断言的另外写法" class="headerlink" title="as断言的另外写法"></a>as断言的另外写法</h1><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> myCanvas = &lt;<span class="title class_">HTMLCanvasElement</span>&gt;<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;main_canvas&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>将断言类型写在前面的括号里，等同于：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> myCanvas = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;main_canvas&quot;</span>) <span class="keyword">as</span> <span class="title class_">HTMLCanvasElement</span>;</span><br></pre></td></tr></table></figure>

<p>但是不能再<code>.tsx</code>中使用。</p>
<!--hexo-->

<h1 id="as-const"><a href="#as-const" class="headerlink" title="as const"></a>as const</h1><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">test1</span>(<span class="params">name: <span class="string">&#x27;html&#x27;</span> | <span class="string">&#x27;css&#x27;</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> obj1 = &#123; <span class="attr">name</span>: <span class="string">&#x27;html&#x27;</span> &#125;;</span><br><span class="line"><span class="title function_">test1</span>(obj1.<span class="property">name</span>);</span><br></pre></td></tr></table></figure>

<p>上面的例子有一个类型错误：<code>Argument of type &#39;string&#39; is not assignable to parameter of type &#39;&quot;html&quot; | &quot;css&quot;&#39;.</code>，这是因为，ts对可读写的变量，推断出的类型是非字面类型。</p>
<p>改下代码：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj1 = &#123; <span class="attr">name</span>: <span class="string">&#x27;html&#x27;</span> &#125; <span class="keyword">as</span> <span class="keyword">const</span>;</span><br></pre></td></tr></table></figure>

<p><code>as const</code>是断言成该变量的字面类型，关于<code>const</code>的字面类型断言解释如下。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a = <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> b = <span class="string">&#x27;2&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>ts对<code>a</code>的推断是<code>string</code>，对<code>b</code>的推断是<code>&#39;2&#39;</code>。在ts的类型推断的设计中，它总是尽可能的推断出更广的类型，但是对于<code>readOnly variable</code>，因为不可变，它的更广的类型就是字面类型。</p>
<p>得益于 <a target="_blank" rel="noopener" href="https://github.com/taoliujun/blog/issues/22#issuecomment-1663199481">https://github.com/taoliujun/blog/issues/22#issuecomment-1663199481</a> ，还可以写成<code>let a = &lt;const&gt;&#39;1&#39;;</code> </p>
<!--hexo-->

<h1 id="非null-undefined声明"><a href="#非null-undefined声明" class="headerlink" title="非null | undefined声明"></a>非null | undefined声明</h1><p>有时候虽然声明一个变量类型是<code>null</code>，但在某个逻辑中它不可能是<code>null</code>，可以使用<code>!</code>来表示它不是<code>null</code>。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> d1 = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;test1&#x27;</span>);</span><br><span class="line"><span class="comment">// &#x27;d1&#x27; is possibly &#x27;null&#x27;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(d1.<span class="title function_">getBoundingClientRect</span>());</span><br><span class="line"><span class="comment">// it is fine</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(d1!.<span class="title function_">getBoundingClientRect</span>());</span><br></pre></td></tr></table></figure>
<!--hexo-->

<h1 id="const-enum"><a href="#const-enum" class="headerlink" title="const enum"></a>const enum</h1><p>ts会将<code>enum</code>完整的编译出来，如下分别是ts源码和编译后的代码：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 源码</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">Sex</span> &#123;</span><br><span class="line">    <span class="title class_">Man</span>,</span><br><span class="line">    <span class="title class_">Woman</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> sex = <span class="title class_">Sex</span>.<span class="property">Man</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 编译结果</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">Sex</span>;</span><br><span class="line">(<span class="keyword">function</span> (<span class="params">Sex</span>) &#123;</span><br><span class="line">    <span class="title class_">Sex</span>[<span class="title class_">Sex</span>[<span class="string">&quot;Man&quot;</span>] = <span class="number">0</span>] = <span class="string">&quot;Man&quot;</span>;</span><br><span class="line">    <span class="title class_">Sex</span>[<span class="title class_">Sex</span>[<span class="string">&quot;Woman&quot;</span>] = <span class="number">1</span>] = <span class="string">&quot;Woman&quot;</span>;</span><br><span class="line">&#125;)(<span class="title class_">Sex</span> || (<span class="title class_">Sex</span> = &#123;&#125;));</span><br><span class="line"><span class="keyword">const</span> sex = <span class="title class_">Sex</span>.<span class="property">Man</span>;</span><br></pre></td></tr></table></figure>

<p>而很多时候，我们只是将<code>enum</code>当安全值来用，编译后只保留安全值就行了。加上<code>const</code>就可以：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 源码</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">enum</span> <span class="title class_">Sex</span> &#123;</span><br><span class="line">    <span class="title class_">Man</span>,</span><br><span class="line">    <span class="title class_">Woman</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> sex = <span class="title class_">Sex</span>.<span class="property">Man</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 编译结果</span></span><br><span class="line"><span class="keyword">const</span> sex = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<!--hexo-->

<h1 id="ts-expect-error"><a href="#ts-expect-error" class="headerlink" title="@ts-expect-error"></a>@ts-expect-error</h1><p>在一些场景下，我们需要故意传一个错误类型的变量，比如在写单元测试的时候。如下：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// util.ts</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">test1</span>(<span class="params">p1: <span class="built_in">number</span></span>) &#123;</span><br><span class="line">  <span class="comment">// do</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// __test__</span></span><br><span class="line"><span class="title function_">test1</span>(<span class="string">&#x27;hello&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>在如上的单元测试代码中，ts会反馈<code>&#39;hello&#39;</code>不是一个number，但这个类型错误正是我们期望的。那么就增加一个标记来处理它：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// __test__</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// @ts-expect-error</span></span><br><span class="line"><span class="title function_">test1</span>(<span class="string">&#x27;hello&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>并且，如果这行语句没有类型错误的话，该注释本身会被认为是一个错误，以及时提醒开发者。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Unused &#x27;@ts-expect-error&#x27; directive.ts(2578)</span></span><br><span class="line"><span class="comment">// @ts-expect-error</span></span><br><span class="line"><span class="title function_">test1</span>(<span class="number">123</span>);</span><br></pre></td></tr></table></figure>

<p>它和<code>ts-ignore</code>的区别在这：<a target="_blank" rel="noopener" href="https://www.typescriptlang.org/docs/handbook/release-notes/typescript-3-9.html#ts-ignore-or-ts-expect-error">https://www.typescriptlang.org/docs/handbook/release-notes/typescript-3-9.html#ts-ignore-or-ts-expect-error</a></p>
<!--hexo-->

<h1 id="解构变量可标记为“不使用”"><a href="#解构变量可标记为“不使用”" class="headerlink" title="解构变量可标记为“不使用”"></a>解构变量可标记为“不使用”</h1><p>如下语句，ts会告诉你<code>first</code>未使用。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &#x27;first&#x27; is declared but its value is never read.ts(6133)</span></span><br><span class="line"><span class="keyword">const</span> [first, second] = [<span class="number">1</span>, <span class="number">2</span>];</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;==&#x27;</span>, second);</span><br></pre></td></tr></table></figure>

<p>但在场景里，就不需要使用第一个变量，ts提供了一个写法标记来忽略检查未使用的解构变量，就是在变量前加<code>_</code>。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> [_first, second] = [<span class="number">1</span>, <span class="number">2</span>];</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;==&#x27;</span>, second);</span><br></pre></td></tr></table></figure>

<p><strong>补充：</strong> 以上是ts4.2的特性，在更新的版本里，只要这样写就行了：<code>const [, second] = [1, 2]</code>。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://taoliujun.github.io/blog/typescript-means/" data-id="clqxkljy60005jgq9acu45xw0" data-title="TypeScript的小手段，最后更新2023/12月..." class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/typescript/" rel="tag">typescript</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/blog/page/2/">2</a><a class="page-number" href="/blog/page/3/">3</a><a class="page-number" href="/blog/page/4/">4</a><a class="extend next" rel="next" href="/blog/page/2/">weiter &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Kategorien</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/blog/categories/JavaScript/">JavaScript</a></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/React/">React</a></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/TypeScript/">TypeScript</a></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/%E5%B7%A5%E7%A8%8B%E5%8C%96/">工程化</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Badging/" rel="tag">Badging</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Beacon/" rel="tag">Beacon</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/ast/" rel="tag">ast</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/badging/" rel="tag">badging</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/changesets/" rel="tag">changesets</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/css-module/" rel="tag">css module</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/es6/" rel="tag">es6</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/github-actions/" rel="tag">github actions</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/javascript/" rel="tag">javascript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/jest/" rel="tag">jest</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/radix/" rel="tag">radix</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/react/" rel="tag">react</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/react-store/" rel="tag">react store</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/typescript/" rel="tag">typescript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/webapi/" rel="tag">webapi</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/zustand/" rel="tag">zustand</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/blog/tags/Badging/" style="font-size: 10px;">Badging</a> <a href="/blog/tags/Beacon/" style="font-size: 10px;">Beacon</a> <a href="/blog/tags/ast/" style="font-size: 10px;">ast</a> <a href="/blog/tags/badging/" style="font-size: 10px;">badging</a> <a href="/blog/tags/changesets/" style="font-size: 10px;">changesets</a> <a href="/blog/tags/css-module/" style="font-size: 10px;">css module</a> <a href="/blog/tags/es6/" style="font-size: 20px;">es6</a> <a href="/blog/tags/github-actions/" style="font-size: 18px;">github actions</a> <a href="/blog/tags/javascript/" style="font-size: 20px;">javascript</a> <a href="/blog/tags/jest/" style="font-size: 10px;">jest</a> <a href="/blog/tags/radix/" style="font-size: 10px;">radix</a> <a href="/blog/tags/react/" style="font-size: 14px;">react</a> <a href="/blog/tags/react-store/" style="font-size: 10px;">react store</a> <a href="/blog/tags/typescript/" style="font-size: 12px;">typescript</a> <a href="/blog/tags/webapi/" style="font-size: 16px;">webapi</a> <a href="/blog/tags/zustand/" style="font-size: 10px;">zustand</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archiv</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2024/02/">February 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2024/01/">January 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2023/12/">December 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2023/09/">September 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2023/08/">August 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2023/07/">July 2023</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">letzter Beitrag</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/blog/web-api-Beacon_api/">Web API - Beacon</a>
          </li>
        
          <li>
            <a href="/blog/web-api-badging_api/">Web API - Badging - 徽章</a>
          </li>
        
          <li>
            <a href="/blog/web-api-Badging_api/">Web API - Badging</a>
          </li>
        
          <li>
            <a href="/blog/web-api-readme/">Web API 实践，最后更新2024/02月...</a>
          </li>
        
          <li>
            <a href="/blog/snapshot-impact-on-coverage/">snapshot对单测覆盖率的影响以及应对方案</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2024 taoliujun<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/blog/" class="mobile-nav-link">Home</a>
  
    <a href="/blog/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/blog/js/jquery-3.6.4.min.js"></script>



  
<script src="/blog/fancybox/jquery.fancybox.min.js"></script>




<script src="/blog/js/script.js"></script>





  </div>
</body>
</html>